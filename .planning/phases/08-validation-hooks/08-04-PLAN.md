---
phase: 08-validation-hooks
plan: 04
type: execute
wave: 4
depends_on: [08-01, 08-02, 08-03]
files_modified:
  - src/graph/validation.rs
autonomous: false
must_haves:
  truths:
    - "Validation module has comprehensive test coverage"
    - "Orphan detection tests create graphs with expected orphan patterns"
    - "Pre-run validation tests verify path checking logic"
    - "ValidationReport serialization tests verify JSON output"
    - "All tests pass with cargo test"
  artifacts:
    - path: "src/graph/validation.rs"
      provides: "Test coverage for validation module"
      contains: "#[cfg(test)] mod tests"
  key_links:
    - from: "validation tests"
      to: "sqlitegraph test utilities"
      via: "Create test graphs with known orphan patterns"
      pattern: "#\\[test\\]"
---

<objective>
Add comprehensive tests for the validation module.

Purpose: Verify validation logic detects orphans correctly and produces valid JSON output.
Output: Test suite covering all validation check functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/08-validation-hooks/08-CONTEXT.md
@.planning/phases/08-validation-hooks/08-RESEARCH.md

@src/graph/validation.rs
@src/graph/tests.rs
@src/graph/mod.rs
@.planning/phases/08-validation-hooks/08-01-SUMMARY.md
@.planning/phases/08-validation-hooks/08-02-SUMMARY.md
@.planning/phases/08-validation-hooks/08-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tests for ValidationReport type</name>
  <files>src/graph/validation.rs</files>
  <action>
    Add unit tests to src/graph/validation.rs in a #[cfg(test)] mod tests block:

    1. test_validation_report_empty():
       - Create ValidationReport with passed=true, empty errors/warnings
       - Assert total_issues() returns 0
       - Assert is_clean() returns true

    2. test_validation_report_with_errors():
       - Create ValidationReport with 2 errors, 1 warning
       - Assert total_issues() returns 3
       - Assert is_clean() returns false

    3. test_validation_error_serialization():
       - Create ValidationError with sample data
       - Serialize to JSON using serde_json::to_string()
       - Verify JSON contains code, message, entity_id, details fields

    4. test_validation_report_serialization():
       - Create ValidationReport with sample errors/warnings
       - Serialize to JSON
       - Verify schema_version compatibility (when wrapped in JsonResponse)

    Follow the test patterns from src/output/command.rs tests module (lines 807-1284).
  </action>
  <verify>
    cargo test --lib validation 2>&1 | grep -E "(test result|running)"
  </verify>
  <done>
    All ValidationReport tests pass.
    total_issues() and is_clean() work correctly.
    Serialization produces valid JSON.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for orphan detection</name>
  <files>src/graph/validation.rs</files>
  <action>
    Add integration tests for orphan detection in src/graph/validation.rs tests block:

    1. test_check_orphan_references_clean_graph():
       - Create a CodeGraph with valid Symbol and Reference nodes
       - Add proper REFERENCES edges
       - Assert check_orphan_references() returns empty Vec

    2. test_check_orphan_references_with_orphans():
       - Create a CodeGraph with a Reference node
       - Do NOT add REFERENCES edge (simulate orphan)
       - Assert check_orphan_references() returns one error
       - Assert error code is "ORPHAN_REFERENCE"

    3. test_check_orphan_calls_clean_graph():
       - Create a CodeGraph with valid Call nodes
       - Add proper CALLER and CALLS edges
       - Assert check_orphan_calls() returns empty Vec

    4. test_check_orphan_calls_missing_caller():
       - Create a Call node without CALLER edge
       - Assert error code is "ORPHAN_CALL_NO_CALLER"

    5. test_check_orphan_calls_missing_callee():
       - Create a Call node without CALLS edge
       - Assert error code is "ORPHAN_CALL_NO_CALLEE"

    6. test_validate_graph_integration():
       - Create a graph with mixed valid/invalid nodes
       - Call validate_graph()
       - Assert report.passed reflects actual state
       - Assert errors are sorted by code

    Use existing test helper patterns from src/graph/tests.rs for graph creation.
    Use tempfile crate for temporary database files (already a dependency).
  </action>
  <verify>
    cargo test --lib validation 2>&1 | grep -E "(test result|running)"
  </verify>
  <done>
    Orphan detection tests pass for clean graphs.
    Orphan detection tests detect missing edges correctly.
    Error codes match expected values (ORPHAN_REFERENCE, ORPHAN_CALL_*).
    validate_graph() produces sorted results.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for pre-run validation</name>
  <files>src/graph/validation.rs</files>
  <action>
    Add tests for pre-run validation in src/graph/validation.rs tests block:

    1. test_pre_run_validate_all_valid():
       - Create temp directory with valid db path
       - Call pre_run_validate() with valid paths
       - Assert report.passed is true
       - Assert errors is empty

    2. test_pre_run_validate_missing_root():
       - Call pre_run_validate() with non-existent root path
       - Assert report.passed is false
       - Assert one error with code "ROOT_PATH_MISSING"

    3. test_pre_run_validate_missing_input_path():
       - Call pre_run_validate() with non-existent input path
       - Assert report.passed is false
       - Assert one error with code "INPUT_PATH_MISSING"

    4. test_pre_run_validate_db_parent_missing():
       - Call pre_run_validate() with db path whose parent doesn't exist
       - Assert report.passed is false
       - Assert one error with code "DB_PARENT_MISSING"

    Use tempfile::tempdir() for temporary directories.
  </action>
  <verify>
    cargo test --lib validation 2>&1 | grep -E "(test result|running)"
  </verify>
  <done>
    Pre-run validation tests pass with valid inputs.
    Pre-run validation detects missing root path.
    Pre-run validation detects missing input paths.
    Pre-run validation detects missing db parent directory.
  </done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Complete validation module test suite</what-built>
  <how-to-verify>
    1. Run all validation tests: cargo test --lib validation
    2. Verify all tests pass
    3. Check test coverage by reviewing test names in output
    4. Run cargo test --workspace to ensure no regressions

    Expected output should show:
    - test_validation_report_empty ... ok
    - test_validation_report_with_errors ... ok
    - test_validation_error_serialization ... ok
    - test_validation_report_serialization ... ok
    - test_check_orphan_references_clean_graph ... ok
    - test_check_orphan_references_with_orphans ... ok
    - test_check_orphan_calls_clean_graph ... ok
    - test_check_orphan_calls_missing_caller ... ok
    - test_check_orphan_calls_missing_callee ... ok
    - test_validate_graph_integration ... ok
    - test_pre_run_validate_all_valid ... ok
    - test_pre_run_validate_missing_root ... ok
    - test_pre_run_validate_missing_input_path ... ok
    - test_pre_run_validate_db_parent_missing ... ok
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any test failures</resume-signal>
</task>

</tasks>

<verification>
1. cargo test --lib validation passes all tests
2. Test coverage includes ValidationReport, orphan detection, and pre-run validation
3. Serialization tests verify JSON output format
4. Integration tests use actual CodeGraph instances
5. No test failures in workspace after running cargo test --workspace
</verification>

<success_criteria>
- All validation tests pass
- Test coverage includes all validation check functions
- Orphan detection tests verify both clean and invalid graphs
- Pre-run validation tests cover all error cases
- JSON serialization tests verify output format
</success_criteria>

<output>
After completion, create `.planning/phases/08-validation-hooks/08-04-SUMMARY.md`
</output>
