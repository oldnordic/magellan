---
phase: 08-validation-hooks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/graph/validation.rs
  - src/graph/mod.rs
autonomous: true
must_haves:
  truths:
    - "Validation module exists with ValidationReport and ValidationError types"
    - "ValidationReport follows VerifyReport pattern (Serialize, Deserialize, helper methods)"
    - "Pre-run validation checks database accessibility and input paths"
    - "Post-run validation checks for orphan references and calls"
    - "Validation errors are deterministically sorted for consistent output"
  artifacts:
    - path: "src/graph/validation.rs"
      provides: "Validation report types and validation check functions"
      min_lines: 150
    - path: "src/graph/mod.rs"
      provides: "Public validation API re-exports"
      exports: ["validate_graph", "pre_run_validate"]
  key_links:
    - from: "src/graph/validation.rs"
      to: "sqlitegraph backend"
      via: "neighbors() with NeighborQuery for orphan detection"
      pattern: "backend\\.neighbors"
    - from: "src/graph/validation.rs"
      to: "src/verify.rs"
      via: "Follows VerifyReport pattern for consistency"
      pattern: "VerifyReport"
---

<objective>
Create the validation module with pre-run and post-run invariant checks.

Purpose: Provide a structured way to verify indexing correctness and detect graph inconsistencies.
Output: New validation.rs module with ValidationReport type and validation functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/08-validation-hooks/08-CONTEXT.md
@.planning/phases/08-validation-hooks/08-RESEARCH.md

@src/graph/mod.rs
@src/graph/references.rs
@src/graph/call_ops.rs
@src/verify.rs
@src/output/command.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation module with ValidationReport type</name>
  <files>src/graph/validation.rs</files>
  <action>
    Create a new src/graph/validation.rs module with:

    1. ValidationReport struct following the VerifyReport pattern from src/verify.rs:
       - pub passed: bool
       - pub errors: Vec<ValidationError>
       - pub warnings: Vec<ValidationWarning>
       - Helper methods: total_issues(), is_clean()

    2. ValidationError struct with:
       - pub code: String (machine-readable SCREAMING_SNAKE_CASE error class)
       - pub message: String (human-readable description)
       - pub entity_id: Option<String> (related stable symbol_id if applicable)
       - pub details: serde_json::Value (additional structured data)
       - Serialize, Deserialize for JSON output

    3. ValidationWarning struct (same structure as ValidationError)

    Use serde::{Deserialize, Serialize} and anyhow::Result. Follow the exact pattern of VerifyReport (lines 14-36 in verify.rs) for consistency.

    Do NOT implement validation check functions yet - that's Task 2.
  </action>
  <verify>
    cargo check --lib 2>&1 | grep -E "(validation|ValidationError|ValidationReport)" || echo "Type definitions compile"
  </verify>
  <done>
    ValidationReport, ValidationError, and ValidationWarning types exist with proper derives.
    Helper methods total_issues() and is_clean() are implemented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement orphan detection validation functions</name>
  <files>src/graph/validation.rs</files>
  <action>
    Implement post-run validation check functions in src/graph/validation.rs:

    1. check_orphan_references(graph: &mut CodeGraph) -> Result<Vec<ValidationError>>
       - Use references.backend.entity_ids() to get all Reference nodes
       - For each Reference, use backend.neighbors() with NeighborQuery:
         * direction: BackendDirection::Outgoing
         * edge_type: Some("REFERENCES".to_string())
       - Empty neighbors result = orphan (no target symbol)
       - Return Vec<ValidationError> with code "ORPHAN_REFERENCE"
       - Include file, line, col in details

    2. check_orphan_calls(graph: &mut CodeGraph) -> Result<Vec<ValidationError>>
       - Use calls.backend.entity_ids() to get all Call nodes
       - For each Call, check both CALLER (Incoming) and CALLS (Outgoing) neighbors
       - Return errors with codes:
         * "ORPHAN_CALL_NO_CALLER" - no caller symbol
         * "ORPHAN_CALL_NO_CALLEE" - no callee symbol
       - Include call_node_id in details

    3. validate_graph(graph: &mut CodeGraph) -> Result<ValidationReport>
       - Run all check functions
       - Collect errors and warnings
       - Sort deterministically by code
       - Return ValidationReport

    Reference the exact neighbor query pattern from src/graph/references.rs lines 199-214.
    Reference the exact node iteration pattern from src/graph/call_ops.rs lines 32-62.

    IMPORTANT: Sort all error vectors before returning for deterministic output (see verify.rs lines 108-112).
  </action>
  <verify>
    cargo check --lib 2>&1
  </verify>
  <done>
    check_orphan_references() detects references with no target symbol.
    check_orphan_calls() detects calls missing caller or callee.
    validate_graph() returns sorted ValidationReport.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement pre-run validation and wire into CodeGraph</name>
  <files>src/graph/validation.rs, src/graph/mod.rs</files>
  <action>
    1. Add pre_run_validate() function to src/graph/validation.rs:
       - Takes db_path: &Path, root_path: &Path, input_paths: &[PathBuf]
       - Returns Result<PreValidationReport> (new type with passed, errors, input_count)
       - Checks:
         * Database parent directory exists
         * Root path exists
         * All input paths exist
       - Returns errors with codes: "DB_PARENT_MISSING", "ROOT_PATH_MISSING", "INPUT_PATH_MISSING"

    2. Update src/graph/mod.rs to add validation module:
       - Add: mod validation;
       - No re-exports needed (validation is internal API for now)

    Reference the verify_graph() function signature from src/verify.rs lines 49-120 for the pattern.

    Note: We don't add validation to CodeGraph struct because validation needs mutable access
    and is called from CLI handlers, not stored as state.
  </action>
  <verify>
    cargo check --lib 2>&1 | grep -E "(error|warning|unused)" || echo "Module compiles"
  </verify>
  <done>
    pre_run_validate() checks database, root, and input path validity.
    validation module is declared in mod.rs and compiles.
    PreValidationReport type exists with required fields.
  </done>
</task>

</tasks>

<verification>
1. cargo check --lib passes with no errors
2. ValidationReport type implements Serialize/Deserialize
3. validate_graph() compiles with correct signature accepting &mut CodeGraph
4. All error codes follow SCREAMING_SNAKE_CASE convention
5. Error vectors are sorted before returning (deterministic output)
</verification>

<success_criteria>
- Validation module exists at src/graph/validation.rs
- ValidationReport follows VerifyReport pattern (Serialize, Deserialize, helper methods)
- Orphan detection uses sqlitegraph neighbor query API correctly
- All errors are deterministically sorted
- Module compiles and is declared in mod.rs
</success_criteria>

<output>
After completion, create `.planning/phases/08-validation-hooks/08-01-SUMMARY.md`
</output>
