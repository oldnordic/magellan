---
phase: 06-query-ux
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - src/main.rs
  - src/files_cmd.rs
autonomous: true

must_haves:
  truths:
    - "User can list all indexed files via 'files' command"
    - "Files output is deterministically ordered (alphabetically by path)"
    - "JSON output uses FilesResponse schema"
    - "Optional --symbols flag shows symbol counts per file"
  artifacts:
    - path: "src/files_cmd.rs"
      provides: "Files command implementation"
      contains: "pub fn run_files"
    - path: "src/main.rs"
      provides: "CLI integration for files command"
      contains: "Command::Files"
  key_links:
    - from: "src/main.rs:run_files"
      to: "CodeGraph::all_file_nodes"
      via: "Fetch all indexed file paths"
    - from: "src/main.rs:parse_args"
      to: "Command::Files"
      via: "Parse 'files' subcommand"
---

<objective>
Create the files command to list all indexed files with optional symbol counts.

Purpose: The files command is referenced in main.rs and FilesResponse exists, but src/files_cmd.rs doesn't exist. Users need to list all indexed files, optionally with symbol counts per file.

Output: Working files command with JSON output and optional --symbols flag.

Context: Research showed run_files() exists in main.rs (lines 824-862) as an inline implementation. This plan extracts it to src/files_cmd.rs and adds the --symbols flag functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-query-ux/06-RESEARCH.md
@src/main.rs
@src/output/command.rs
@src/graph/query.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create files_cmd.rs module</name>
  <files>src/files_cmd.rs</files>
  <action>
    Create new src/files_cmd.rs file with run_files() function.

    Extract existing implementation from main.rs lines 824-862.

    Signature:
    ```rust
    use anyhow::Result;
    use std::path::PathBuf;
    use magellan::CodeGraph;
    use magellan::output::{JsonResponse, OutputFormat, FilesResponse, output_json, generate_execution_id};

    pub fn run_files(
        db_path: PathBuf,
        output_format: OutputFormat,
        with_symbols: bool,
    ) -> Result<()>
    ```

    Implementation:
    1. Open graph database
    2. Generate execution_id and start tracking
    3. Get all file nodes via graph.all_file_nodes()?
    4. If with_symbols flag is set, count symbols per file
    5. Sort files deterministically (alphabetically)
    6. Output JSON or human format

    For JSON output with --symbols:
    - Extend FilesResponse to include symbol_counts
    - Use HashMap<String, usize> for file -> count mapping

    For human output with --symbols:
    - Show "path (N symbols)" format
  </action>
  <verify>
    cargo check
  </verify>
  <done>
    src/files_cmd.rs exists with run_files() function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend FilesResponse for symbol counts</name>
  <files>src/output/command.rs</files>
  <action>
    In src/output/command.rs, extend FilesResponse (around line 711) to optionally include symbol counts:

    ```rust
    #[derive(Debug, Clone, Serialize, Deserialize)]
    pub struct FilesResponse {
        /// All indexed files (sorted deterministically)
        pub files: Vec<String>,
        /// Symbol count per file (optional, when --symbols flag is used)
        #[serde(skip_serializing_if = "Option::is_none")]
        pub symbol_counts: Option<std::collections::HashMap<String, usize>>,
    }
    ```
  </action>
  <verify>
    cargo check
  </verify>
  <done>
    FilesResponse includes optional symbol_counts field.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update main.rs to use files_cmd module</name>
  <files>src/main.rs</files>
  <action>
    In src/main.rs:

    1. Add mod declaration at top (around line 8):
    ```rust
    mod files_cmd;
    ```

    2. Update Command enum Files variant (around line 151) to include with_symbols flag:
    ```rust
    Files {
        db_path: PathBuf,
        with_symbols: bool,
    },
    ```

    3. Update parse_args() for "files" command (around line 505) to parse --symbols flag:
    ```rust
    "files" => {
        let mut db_path: Option<PathBuf> = None;
        let mut with_symbols = false;

        let mut i = 2;
        while i < args.len() {
            match args[i].as_str() {
                "--db" => {
                    if i + 1 >= args.len() {
                        return Err(anyhow::anyhow!("--db requires an argument"));
                    }
                    db_path = Some(PathBuf::from(&args[i + 1]));
                    i += 2;
                }
                "--symbols" => {
                    with_symbols = true;
                    i += 1;
                }
                _ => {
                    return Err(anyhow::anyhow!("Unknown argument: {}", args[i]));
                }
            }
        }

        let db_path = db_path.ok_or_else(|| anyhow::anyhow!("--db is required"))?;
        Ok(Command::Files { db_path, with_symbols })
    }
    ```

    4. Replace inline run_files() with call to files_cmd::run_files() (around line 1052):
    ```rust
    Ok(Command::Files { db_path, with_symbols }) => {
        if let Err(e) = files_cmd::run_files(db_path, with_symbols, output_format) {
            eprintln!("Error: {}", e);
            return ExitCode::from(1);
        }
        ExitCode::SUCCESS
    }
    ```

    5. Remove inline run_files() function (lines 824-862)
  </action>
  <verify>
    cargo check
  </verify>
  <done>
    main.rs uses files_cmd module and passes --symbols flag.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add --symbols flag to help text</name>
  <files>src/main.rs</files>
  <action>
    In print_usage() function (around line 91), update files command documentation:

    ```rust
    eprintln!("Files arguments:");
    eprintln!("  --db <FILE>         Path to sqlitegraph database");
    eprintln!("  --symbols           Show symbol count per file");
    ```

    Also update general command list (around line 46):
    ```rust
    eprintln!("  files     List all indexed files");
    ```
  </action>
  <verify>
    cargo run -- --help | grep -A5 "files"
  </verify>
  <done>
    Help text shows files command usage with --symbols flag.
  </done>
</task>

<task type="auto">
  <name>Task 5: Add tests for files command</name>
  <files>tests/cli_query_tests.rs</files>
  <action>
    Add tests for files command (existing tests exist at lines 1016-1102, verify they still pass).

    Add new test:
    ```rust
    #[test]
    fn test_files_with_symbol_counts() {
        // Test --symbols flag shows counts per file
    }
    ```

    Place after test_files_empty_database (around line 1103).

    Test should:
    1. Create multiple files with varying symbol counts
    2. Index files
    3. Run files --db test.db --output json --symbols
    4. Parse JSON and verify symbol_counts field exists
    5. Verify counts match actual symbols in each file
  </action>
  <verify>
    cargo test test_files
  </verify>
  <done>
    Tests verify files command works with and without --symbols flag.
  </done>
</task>

</tasks>

<verification>
1. cargo check passes
2. magellan files --db test.db lists all files
3. magellan files --db test.db --symbols shows counts
4. magellan files --db test.db --output json produces valid JSON
5. Existing files tests still pass
6. New test validates --symbols flag
</verification>

<success_criteria>
1. src/files_cmd.rs exists with run_files() function
2. files command lists all indexed files deterministically
3. --symbols flag shows symbol counts per file
4. JSON output uses FilesResponse schema
5. Help text documents the command
6. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-query-ux/06-04-SUMMARY.md`
</output>
