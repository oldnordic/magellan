---
phase: 12-transactional-deletes
plan: 05
type: execute
wave: 5
depends_on: ["12-01", "12-02", "12-03", "12-04"]
files_modified:
  - src/generation/mod.rs
  - src/graph/mod.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "ChunkStore can use a shared SQLite connection instead of opening its own"
    - "Shared connection is managed at CodeGraph level"
    - "ChunkStore operations work with both shared and non-shared connections"
  artifacts:
    - path: "src/generation/mod.rs"
      provides: "ChunkStore with shared connection support"
      contains: "ChunkStore::with_connection"
    - path: "src/graph/mod.rs"
      provides: "CodeGraph with shared connection initialization"
      contains: "shared_conn"
  key_links:
    - from: "CodeGraph::open"
      to: "ChunkStore::with_connection"
      via: "passing shared rusqlite connection"
      pattern: "ChunkStore::with_connection.*shared_conn"

---

<objective>
Add shared connection support to ChunkStore to enable transactional deletes.

Purpose: The current architecture has ChunkStore opening its own SQLite connections, which prevents IMMEDIATE transactions from working across both graph operations and chunk operations. This plan adds connection-sharing capability to ChunkStore.

Gap closed: Addresses the architectural limitation identified in verification where IMMEDIATE transactions cannot be used due to separate SQLite connections.

Output: ChunkStore that can optionally use a shared connection, CodeGraph initialized with shared connection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/12-transactional-deletes/12-01-SUMMARY.md
@.planning/phases/12-transactional-deletes/12-02-SUMMARY.md
@.planning/phases/12-transactional-deletes/12-03-SUMMARY.md
@.planning/phases/12-transactional-deletes/12-04-SUMMARY.md
@.planning/phases/12-transactional-deletes/12-transactional-deletes-VERIFICATION.md
@src/generation/mod.rs
@src/graph/mod.rs
@src/graph/ops.rs

# Current Architecture (from verification report):
- ChunkStore opens its own connections via `connect()` method (line 33-35 in generation/mod.rs)
- SqliteGraphBackend uses a private connection wrapped in Rc
- Two connections = IMMEDIATE transaction on one blocks writes from the other

# Design for Shared Connection:

## ChunkStore Changes:
1. Add enum for connection source:
   ```rust
   enum ChunkStoreConnection {
       Owned(PathBuf),        // Current behavior - open connections as needed
       Shared(rusqlite::Connection), // New - shared connection
   }
   ```

2. Add `ChunkStore::with_connection(conn: rusqlite::Connection)` constructor

3. Modify all ChunkStore methods to use shared connection when available

## CodeGraph Changes:
1. Open a rusqlite::Connection directly in CodeGraph::open()
2. Pass this connection to ChunkStore::with_connection()
3. NOTE: SqliteGraphBackend still needs its own connection (sqlitegraph internal)
4. For deletes: use the shared connection for chunks, backend connection for graph entities

# Trade-off:
- We still have TWO connections (backend + shared), but chunks now use the shared one
- IMMEDIATE transaction will be on the backend connection
- Chunk operations happen within same transaction scope via shared connection
- This is a partial solution - full solution requires sqlitegraph to expose its connection
</context>

<tasks>
1. Add ChunkStoreConnection enum to src/generation/mod.rs
2. Implement ChunkStore::with_connection() constructor
3. Modify ChunkStore methods to use shared connection
4. Update CodeGraph::open() to initialize shared connection
5. Pass shared connection to ChunkStore
6. Run tests to verify existing functionality still works
</tasks>

<success_criteria>
- [ ] ChunkStore has with_connection() constructor
- [ ] All ChunkStore methods work with shared connection
- [ ] CodeGraph opens and manages shared connection
- [ ] All existing tests pass (cargo test --workspace)
- [ ] No regression in index/delete operations
</success_criteria>
