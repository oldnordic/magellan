---
phase: 01-persistence-compatibility-baseline
plan: 03
type: execute
wave: 3
depends_on:
  - 01-02
files_modified:
  - src/graph/db_compat.rs
  - src/graph/mod.rs
  - src/generation/mod.rs
  - tests/phase1_persistence_compatibility.rs
autonomous: true
must_haves:
  truths:
    - "When a user opens a DB with --db <FILE>, Magellan records a schema compatibility version in the database."
    - "If a DB is incompatible, Magellan exits with an error without mutating sqlite_master (no new tables created)."
  artifacts:
    - path: "tests/phase1_persistence_compatibility.rs"
      provides: "regression tests for DB-02: schema version recorded + no partial mutation"
    - path: "src/graph/db_compat.rs"
      provides: "magellan_meta schema ensure + version read/verify"
  key_links:
    - from: "src/graph/mod.rs"
      to: "magellan_meta"
      via: "ensure_magellan_meta after sqlitegraph open"
      pattern: "magellan_meta"
    - from: "tests/phase1_persistence_compatibility.rs"
      to: "CodeGraph::open"
      via: "opens temp db + asserts schema tables/versions"
      pattern: "CodeGraph::open"
---

<objective>
Record Magellan-side schema versioning metadata and add regression tests proving Phase 1 behaviors (DB-02).

Purpose: Make DB compatibility explicit and machine-checkable by storing Magellan’s own schema version (and the sqlitegraph schema version it was validated against) and proving the "no partial mutation" guarantee with tests.
Output: `magellan_meta` table (versioned) + tests that validate open behavior for new DBs and incompatible DBs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-persistence-compatibility-baseline/01-RESEARCH.md
@src/graph/mod.rs
@src/generation/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Magellan-owned metadata table (magellan_meta) with schema version</name>
  <files>src/graph/db_compat.rs, src/graph/mod.rs</files>
  <action>
- Extend the Phase 1 DB compatibility module to include Magellan-owned schema versioning.

Design constraints:
- Do NOT overload sqlitegraph’s `graph_meta` for Magellan-specific versioning (sqlitegraph owns it).
- Because sqlitegraph’s `Connection` is private, use a separate `rusqlite::Connection` opened on the same DB path (same approach as ChunkStore).
- Ensure ordering: only create/update `magellan_meta` AFTER sqlitegraph preflight has succeeded and AFTER sqlitegraph open has succeeded (no side-table writes on incompatible DBs).

Schema recommendation (keep minimal but explicit):
- Table: `magellan_meta`
- Single-row, `id=1`
- Columns:
  - `magellan_schema_version INTEGER NOT NULL`
  - `sqlitegraph_schema_version INTEGER NOT NULL`
  - `created_at INTEGER NOT NULL` (unix epoch seconds) OR omit if not needed

Behavior:
- On new DB open: insert row id=1 with current versions.
- On existing DB open:
  - If table missing: create and insert row.
  - If table exists:
    - If stored `magellan_schema_version` != current expected: refuse to proceed with clear error (Phase 1 compatibility gate).
    - If stored `sqlitegraph_schema_version` != expected: refuse (defensive; should not happen if preflight enforced).

Pick and define `MAGELLAN_SCHEMA_VERSION` constant (start at 1) in a suitable module and use it in checks.

Update `CodeGraph::open()` to call `ensure_magellan_meta(...)` in the correct place.
  </action>
  <verify>
- `cargo test --workspace`
  </verify>
  <done>
- Opening a DB results in `magellan_meta` existing with a single row (id=1) containing the current Magellan schema version and sqlitegraph schema version.
- If versions mismatch, open fails deterministically before any additional writes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Gate ChunkStore schema creation behind compatibility + add regression tests</name>
  <files>src/generation/mod.rs, tests/phase1_persistence_compatibility.rs</files>
  <action>
- Ensure `ChunkStore::ensure_schema()` is only called after:
  1) sqlitegraph preflight succeeds (existing DB)
  2) sqlitegraph open succeeds
  3) magellan_meta has been checked/created successfully

If the current call order in `CodeGraph::open()` violates this, adjust accordingly.

Add integration tests in `tests/phase1_persistence_compatibility.rs` covering:

A) "New DB records schema versions":
- Create a temp directory and choose a new DB file path.
- Call `CodeGraph::open(db_path)`.
- Using `rusqlite`, assert:
  - `graph_meta` exists and `schema_version` row exists (sqlitegraph side)
  - `magellan_meta` exists and has row id=1 with expected `magellan_schema_version` and expected `sqlitegraph_schema_version`.

B) "Incompatible DB is refused without partial mutation":
- Create a SQLite file that is NOT a sqlitegraph DB (e.g., a DB with a dummy table but no `graph_meta`).
- Snapshot table names from `sqlite_master`.
- Call `CodeGraph::open(db_path)` and assert it returns error.
- Re-read `sqlite_master` table names and assert they are unchanged (no new tables were created).

C) (Optional if easy) "Mismatched sqlitegraph schema_version is refused":
- Create a SQLite file with `graph_meta` table and insert row id=1 with a clearly wrong schema_version.
- Assert `CodeGraph::open` fails and does not add any other tables.

Notes:
- Tests should be deterministic; avoid depending on current time except where required (if `created_at` exists, only assert it is non-zero).
  </action>
  <verify>
- `cargo test --workspace`
  </verify>
  <done>
- Tests pass proving:
  - schema version metadata is recorded for new DBs
  - incompatible DBs are rejected without schema mutations
  </done>
</task>

</tasks>

<verification>
- Run `cargo test --workspace` and confirm the new Phase 1 tests pass.
- Manually sanity check: `cargo run -- status --db /tmp/magellan_phase1_test.db` after a failing open attempt should not show partial tables for incompatible DBs.
</verification>

<success_criteria>
- Phase 1 roadmap success criteria all satisfied:
  1) Local sqlitegraph checkout used (Plan 01)
  2) Schema version(s) recorded in DB (`graph_meta` + `magellan_meta`)
  3) Incompatible DBs refused without partial mutation (tests prove).
</success_criteria>

<output>
After completion, create `.planning/phases/01-persistence-compatibility-baseline/01-03-SUMMARY.md`.
</output>
