---
phase: 04-canonical-span-model
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/output/command.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Span IDs generated with SHA-256 are deterministic (same inputs produce same ID)"
    - "Span IDs are 16 hex characters (64-bit) derived from (file_path, byte_start, byte_end)"
    - "SHA-256 is used instead of DefaultHasher (platform-independent)"
    - "No changes to JSON schema (only ID format changes)"
  artifacts:
    - path: "src/output/command.rs"
      provides: "Span::generate_id() with SHA-256"
      contains: "sha2::Sha256"
    - path: "Cargo.toml"
      provides: "sha2 dependency"
      contains: "sha2 = \"0.10\""
  key_links:
    - from: "src/output/command.rs:Span::generate_id()"
      to: "sha2 crate"
      via: "use sha2::{Sha256, Digest}"
      pattern: "sha2::"
---

<objective>
Implement SHA-256 based stable span ID generation

Purpose: Replace the DefaultHasher placeholder with a platform-independent SHA-256 hash function for generating stable span IDs. This ensures span IDs are deterministic across different platforms and builds, satisfying ID-01 (canonical span model).

Output: Updated Span::generate_id() using SHA-256, with 16-character hex IDs (64-bit) for readability while maintaining collision resistance.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/04-canonical-span-model/04-RESEARCH.md
@src/output/command.rs
@Cargo.toml

# Phase 3 Context
@.planning/phases/03-cli-output-contract/03-03-SUMMARY.md

The Span type was created in Phase 3 with a placeholder generate_id() using DefaultHasher. The comment explicitly states "Phase 4 will implement proper stable span_id generation per ID-01."
</context>

<tasks>

<task type="auto">
  <name>Implement SHA-256 span ID generation</name>
  <files>src/output/command.rs</files>
  <action>
Replace the Span::generate_id() method (lines 68-81) to use SHA-256 instead of DefaultHasher:

1. Add imports at top of file: `use sha2::{Sha256, Digest};`
2. Replace the generate_id() implementation with:
   - Create Sha256 hasher
   - Update with file_path bytes
   - Update with separator ":"
   - Update with byte_start as big-endian bytes (8 bytes)
   - Update with separator ":"
   - Update with byte_end as big-endian bytes (8 bytes)
   - Finalize and take first 8 bytes (64 bits)
   - Format as 16 hex characters

3. Update the docstring to remove "placeholder" language and document the SHA-256 approach

DO NOT change:
- The function signature (must accept &str, usize, usize, return String)
- The Span struct definition
- Any other methods in Span

The sha2 crate is already in Cargo.toml (line 45: sha2 = "0.10").
  </action>
  <verify>
cargo test --lib output::command::tests::test_span_generate_id_is_deterministic
  </verify>
  <done>
Span::generate_id() produces 16-character hex IDs that are deterministic across multiple calls with same inputs. Tests pass.
  </done>
</task>

</tasks>

<verification>
Run full test suite to ensure no regressions:
```bash
cargo test --workspace
```

Verify the new IDs are deterministic:
```bash
cargo test --lib output::command::tests::test_span_generate_id_is_deterministic -- --nocapture
```

Check that IDs are 16 hex characters:
```bash
cargo test --lib output::command::tests
```

Verify no breaking changes to JSON schema:
```bash
cargo test --lib
```
</verification>

<success_criteria>
1. Span::generate_id() uses SHA-256 instead of DefaultHasher
2. Generated span_id is 16 hex characters (64-bit)
3. Same (file_path, byte_start, byte_end) produces identical span_id
4. Different inputs produce different span_ids
5. All existing tests pass (no breaking changes)
6. Docstring reflects SHA-256 implementation, not placeholder
</success_criteria>

<output>
After completion, create `.planning/phases/04-canonical-span-model/04-01-SUMMARY.md`
</output>
