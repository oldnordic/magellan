---
phase: 04-canonical-span-model
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/output/command.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Span ID generation is deterministic across runs (same inputs = same output)"
    - "Span IDs are unique for different file paths, positions, or spans"
    - "UTF-8 files with multi-byte characters are handled safely"
    - "Half-open range semantics work correctly (end is exclusive)"
    - "Byte offsets are safe for UTF-8 slicing"
  artifacts:
    - path: "src/output/command.rs"
      provides: "Comprehensive span tests"
      contains: "#[cfg(test)] mod tests"
    - path: "tests/span_tests.rs"
      provides: "Integration tests for span model"
  key_links:
    - from: "src/output/command.rs::tests"
      to: "Span::generate_id()"
      via: "test assertions"
      pattern: "assert_eq!"
---

<objective>
Add comprehensive span model tests for determinism, UTF-8 safety, and half-open semantics

Purpose: Ensure the span model behaves correctly across edge cases including non-ASCII source files, UTF-8 multi-byte characters, and validates the half-open range semantics [start, end). Tests prove OUT-04 is satisfied.

Output: Comprehensive unit tests in src/output/command.rs and integration tests in tests/span_tests.rs covering all span model guarantees.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/04-canonical-span-model/04-RESEARCH.md
@src/output/command.rs
@src/ingest/mod.rs

# Phase 3 Summary
@.planning/phases/03-cli-output-contract/03-03-SUMMARY.md

# Research-driven test requirements from 04-RESEARCH.md:
- Determinism: same inputs produce same ID
- UTF-8 safety: multi-byte characters handled correctly
- Half-open semantics: byte_end is exclusive
- Line/col accuracy: matches tree-sitter output
</context>

<tasks>

<task type="auto">
  <name>Add span ID determinism and uniqueness tests</name>
  <files>src/output/command.rs</files>
  <action>
Add the following tests to the existing #[cfg(test)] mod tests block in src/output/command.rs:

1. test_span_id_deterministic_multiple_calls - Call generate_id() 100 times with same inputs, verify all equal
2. test_span_id_unique_different_files - Same position in different files produces different IDs
3. test_span_id_unique_different_positions - Same file, different positions produce different IDs
4. test_span_id_format - Verify output is exactly 16 hex characters
5. test_span_id_zero_length_span - Span where start == end is valid and produces stable ID
6. test_span_id_case_sensitive - File paths are case-sensitive

Place these tests after the existing test_span_generate_id_is_deterministic test (around line 325).

Each test should:
- Use assert_eq! or assert_ne! for verification
- Have descriptive names matching the test purpose
- Include comments explaining what edge case is being tested
  </action>
  <verify>
cargo test --lib output::command::tests::test_span_id
  </verify>
  <done>
All new span ID tests pass. Determinism and uniqueness verified.
  </done>
</task>

<task type="auto">
  <name>Add UTF-8 safety tests</name>
  <files>src/output/command.rs</files>
  <action>
Add UTF-8 handling tests to the test block:

1. test_span_id_utf8_file_path - Non-ASCII characters in file path handled correctly
2. test_span_id_multibyte_characters - Emoji, CJK characters in file path
3. test_utf8_safe_extraction - Demonstrate using source.get(byte_start..byte_end) for safe slicing
4. test_utf8_validation - Use source.is_char_boundary() to validate offsets

These tests verify that:
- UTF-8 file paths generate valid span IDs
- Multi-byte UTF-8 sequences don't break ID generation
- Byte offsets can be validated for UTF-8 safety before slicing

Note: Tree-sitter guarantees byte offsets are at valid UTF-8 boundaries (verified in RESEARCH.md), so these tests document that guarantee.
  </action>
  <verify>
cargo test --lib output::command::tests::test_utf8
  </verify>
  <done>
UTF-8 safety tests pass. Multi-byte characters handled correctly.
  </done>
</task>

<task type="auto">
  <name>Add half-open range semantics tests</name>
  <files>tests/span_tests.rs</files>
  <action>
Create a new integration test file tests/span_tests.rs with comprehensive half-open semantics tests:

1. test_half_open_span_extraction - Verify source[span.byte_start..span.byte_end] extracts correct text
2. test_span_length_equals_byte_end_minus_start - length = end - start (no +1 needed)
3. test_adjacent_spans_no_overlap - Two spans [0, 5) and [5, 10) have no gap or overlap
4. test_empty_span_valid - Span where byte_start == byte_end is valid
5. test_end_position_exclusive - end_line/end_col point to position AFTER the span

Use real source code examples like "fn main() {}" to demonstrate half-open semantics in practice.

Reference existing documentation in src/output/command.rs lines 48-50.
  </action>
  <verify>
cargo test --test span_tests
  </verify>
  <done>
Half-open semantics verified. All integration tests pass.
  </done>
</task>

<task type="auto">
  <name>Add line/column conversion tests</name>
  <files>tests/span_tests.rs</files>
  <action>
Add line/column conversion tests to tests/span_tests.rs:

1. test_byte_offset_to_line_col - Convert byte offset to (line, col)
2. test_line_col_to_byte_offset - Convert (line, col) back to byte offset
3. test_span_roundtrip_conversion - byte offsets -> line/col -> byte offsets preserves original
4. test_multibyte_column_is_byte_based - Column is byte offset in line, NOT character offset

These tests document that tree-sitter provides byte-based column offsets (verified in RESEARCH.md from tree-sitter Issue #397).

Implement helper functions:
- byte_offset_to_line_col(source: &str, byte_offset: usize) -> Option<(usize, usize)>
- line_col_to_byte_offset(source: &str, line: usize, col: usize) -> Option<usize>

Place these as test-only helpers (#[cfg(test)]).
  </action>
  <verify>
cargo test --test span_tests --test-threads=1
  </verify>
  <done>
Line/column conversion tests pass. Byte-based column behavior documented.
  </done>
</task>

</tasks>

<verification>
Run all tests including new span tests:
```bash
cargo test --workspace
```

Run specific test groups:
```bash
cargo test --lib output::command::tests::test_span_id
cargo test --lib output::command::tests::test_utf8
cargo test --test span_tests
```

Verify test coverage is comprehensive:
```bash
cargo test --workspace -- --list | grep span
```

Run clippy to ensure code quality:
```bash
cargo clippy --all-targets --all-features
```
</verification>

<success_criteria>
1. Span ID determinism tests verify same inputs always produce same output
2. Uniqueness tests verify different inputs produce different IDs
3. UTF-8 tests verify multi-byte characters handled correctly
4. Half-open semantics tests verify [start, end) range behavior
5. Line/column conversion tests verify roundtrip correctness
6. All workspace tests pass
7. No clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/04-canonical-span-model/04-02-SUMMARY.md`
</output>
