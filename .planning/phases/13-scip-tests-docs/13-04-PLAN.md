---
phase: 13-scip-tests-docs
plan: 04
type: execute
wave: 3
depends_on: []
files_modified:
  - MANUAL.md
autonomous: true
must_haves:
  truths:
    - "MANUAL.md has Security Best Practices section (section 8)"
    - "Database placement guidance covers all major platforms"
    - "Path validation security features are documented"
    - "Example commands demonstrate secure usage patterns"
  artifacts:
    - path: "MANUAL.md"
      provides: "Comprehensive operator manual with security section"
      contains: "## 8. Security Best Practices"
      min_lines: 450  # after adding security section
  key_links:
    - from: "MANUAL.md"
      to: "README.md Security section"
      via: "cross-reference to README for quick reference"
      pattern: "README.*Security"
    - from: "MANUAL.md"
      to: "src/validation.rs"
      via: "reference to path validation implementation"
      pattern: "src/validation.rs"
---

<objective>
Add comprehensive Security Best Practices section to the operator manual.

Purpose: MANUAL.md is the comprehensive reference for Magellan operators. Adding a Security Best Practices section ensures users have detailed guidance on secure configuration and operation, complementing the brief overview in README.md.

Output: MANUAL.md with section 8 "Security Best Practices" covering database placement, path validation, and secure operation patterns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/13-scip-tests-docs/13-RESEARCH.md
@MANUAL.md
@README.md
@src/validation.rs
</context>

<tasks>

<task type="auto">
  <name>Add section 8 Security Best Practices to MANUAL.md</name>
  <files>MANUAL.md</files>
  <action>
    Add "## 8. Security Best Practices" to MANUAL.md after section 7 (Troubleshooting).

    Update the Table of Contents to include:
    ```markdown
    8. [Security Best Practices](#8-security-best-practices)
    ```

    Add the section with the following subsections:

    8.1 Database Placement
    8.2 Path Traversal Protection
    8.3 File Permission Recommendations
    8.4 Secure Operation Patterns

    Structure each subsection with:
    - Explanation of the security concern
    - Recommended practices
    - Examples
    - What to avoid

    Place the new section before "Exit Codes" and "License" at the end of the file.
  </action>
  <verify>grep -q "## 8. Security Best Practices" /home/feanor/Projects/magellan/MANUAL.md</verify>
  <done>MANUAL.md contains section 8 with 4 subsections</done>
</task>

<task type="auto">
  <name>Document database placement by platform</name>
  <files>MANUAL.md</files>
  <action>
    Flesh out subsection 8.1 Database Placement with platform-specific guidance:

    ```markdown
    ### 8.1 Database Placement

    Magellan stores all indexed data in the file specified by `--db <FILE>`.
    The location of this file affects both security and performance.

    **Why Database Location Matters**

    If the database is placed inside a watched directory:
    - The watcher may process the database as a source file
    - Export operations could include binary database content
    - File system events may cause circular processing

    **Recommended Locations by Platform**

    **Linux/macOS:**
    ```bash
    # XDG cache directory (recommended)
    magellan watch --root ~/project --db ~/.cache/magellan/project.db

    # XDG data directory (for long-term storage)
    magellan watch --root ~/project --db ~/.local/share/magellan/project.db

    # Home directory (simple alternative)
    magellan watch --root ~/project --db ~/.$PROJECT_NAME.db
    ```

    **Windows:**
    ```cmd
    REM Local app data (recommended)
    magellan watch --root C:\project --db %LOCALAPPDATA%\magellan\project.db

    REM User profile (simple alternative)
    magellan watch --root C:\project --db %USERPROFILE%\project.db
    ```

    **CI/CD Environments:**
    ```bash
    # Use a cache directory outside the workspace
    magellan watch --root . --db $CI_PROJECT_DIR/../cache/magellan.db
    ```

    **What to Avoid:**

    ```bash
    # AVOID: Database inside watched directory
    magellan watch --root . --db ./magellan.db

    # AVOID: Database in source code directory
    magellan watch --root ~/src/project --db ~/src/project/.magellan.db
    ```
    ```

    Include this content in subsection 8.1.
  </action>
  <verify>grep -A50 "### 8.1 Database Placement" /home/feanor/Projects/magellan/MANUAL.md | grep -q "Linux/macOS"</verify>
  <done>Database placement subsection covers Linux, macOS, Windows, CI/CD</done>
</task>

<task type="auto">
  <name>Document path traversal protection</name>
  <files>MANUAL.md</files>
  <action>
    Flesh out subsection 8.2 Path Traversal Protection:

    ```markdown
    ### 8.2 Path Traversal Protection

    Magellan includes protection against directory traversal attacks that attempt
    to access files outside the watched directory.

    **Automatic Protections**

    Magellan's path validation (`src/validation.rs`) automatically:
    - Rejects paths with 3+ parent directory patterns (`../../../etc/passwd`)
    - Validates resolved paths against the project root
    - Checks symlinks to ensure they don't escape the watched directory
    - Rejects mixed traversal patterns (`./subdir/../../etc`)

    **Validation Points**

    Path validation is applied at:
    - Watcher event processing (every file change event)
    - Directory scanning (recursive directory walk)
    - File indexing operations (before reading file contents)

    **Example Attack Prevention**

    ```bash
    # This input is automatically rejected:
    magellan watch --root ~/project --db ~/db  # But if a malicious event tries:
    # ../../../../../etc/passwd  -> Rejected (suspicious traversal)
    # ./subdir/../../../etc  -> Rejected (mixed pattern)

    # Symlinks outside root are rejected:
    ln -s /etc/passwd project/link
    magellan watch --root project --db ~/db  # link rejected
    ```

    **Security Auditing**

    To verify path protection is working:
    ```bash
    # Run path validation tests
    cargo test path_validation

    # Check implementation
    grep -r "validate_path" src/
    ```
    ```

    Include this content in subsection 8.2.
  </action>
  <verify>grep -A50 "### 8.2 Path Traversal Protection" /home/feanor/Projects/magellan/MANUAL.md | grep -q "src/validation.rs"</verify>
  <done>Path traversal subsection documents automatic protections</done>
</task>

<task type="auto">
  <name>Document file permissions and secure patterns</name>
  <files>MANUAL.md</files>
  <action>
    Flesh out subsections 8.3 and 8.4:

    ```markdown
    ### 8.3 File Permission Recommendations

    **Database File Permissions**

    The database contains complete code structure information. Restrict access:

    ```bash
    # Set restrictive permissions on database directory
    mkdir -p ~/.cache/magellan
    chmod 700 ~/.cache/magellan

    # Database files inherit directory permissions
    magellan watch --root ~/project --db ~/.cache/magellan/project.db
    ```

    **Source Directory Permissions**

    Magellan needs read access to source files:
    - Read permission on source files
    - Execute permission on source directories (for traversal)
    - Write permission only needed for database location

    **Multi-User Environments**

    For shared systems:
    ```bash
    # Create group-writable cache directory
    sudo groupadd magellan
    sudo usermod -a -G magellan $USER
    sudo mkdir -p /var/cache/magellan
    sudo chgrp magellan /var/cache/magellan
    sudo chmod 770 /var/cache/magellan

    # Use shared cache
    magellan watch --root ~/project --db /var/cache/magellan/$USER-project.db
    ```

    ### 8.4 Secure Operation Patterns

    **Production Monitoring**

    ```bash
    # Run with nohup for persistence
    nohup magellan watch --root /app/src --db /var/cache/mag/app.db \
      --scan-initial > /var/log/magellan.log 2>&1 &

    # Check status separately
    magellan status --db /var/cache/mag/app.db
    ```

    **Docker Environments**

    ```dockerfile
    # Use volume for database outside source mount
    docker run -v /src:/app:ro -v /cache:/data magellan \
      watch --root /app --db /data/app.db --scan-initial
    ```

    **Verification Before Deployment**

    ```bash
    # 1. Test path validation
    cargo test path_validation_tests

    # 2. Verify database location
    magellan status --db /var/cache/mag/app.db

    # 3. Check for accidental database inclusion in exports
    magellan export --db /var/cache/mag/app.db | grep -v "sqlite"
    ```
    ```

    Include this content in subsections 8.3 and 8.4.
  </action>
  <verify>grep -q "### 8.3 File Permission Recommendations" /home/feanor/Projects/magellan/MANUAL.md</verify>
  <done>File permissions and secure patterns documented</done>
</task>

<task type="auto">
  <name>Update MANUAL.md Table of Contents</name>
  <files>MANUAL.md</files>
  <action>
    Update the Table of Contents at the top of MANUAL.md to include the new section.

    Add after line 16 (after "7. Troubleshooting"):
    ```markdown
    8. [Security Best Practices](#8-security-best-practices)
    ```

    Also update the section numbers if needed (Exit Codes becomes section 9, License becomes section 10).

    Verify all sections are numbered correctly after adding section 8.
  </action>
  <verify>head -20 /home/feanor/Projects/magellan/MANUAL.md | grep -q "8. Security Best Practices"</verify>
  <done>Table of Contents includes section 8 with correct numbering</done>
</task>

</tasks>

<verification>
1. MANUAL.md has section 8 "Security Best Practices"
2. Section has 4 subsections (8.1-8.4)
3. Table of Contents updated
4. Cross-reference to README Security section included
5. Platform-specific examples provided
6. src/validation.rs referenced for implementation details
</verification>

<success_criteria>
- Security Best Practices section is comprehensive
- All platforms (Linux/macOS/Windows) covered
- File permissions guidance included
- Secure operation patterns documented
- Manual users have actionable security guidance
</success_criteria>

<output>
After completion, create `.planning/phases/13-scip-tests-docs/13-04-SUMMARY.md`
</output>
