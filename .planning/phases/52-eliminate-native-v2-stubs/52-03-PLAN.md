---
phase: 52-eliminate-native-v2-stubs
plan: 03
type: execute
wave: 2
depends_on: ["52-01"]
files_modified:
  - src/graph/execution_log.rs
autonomous: true

must_haves:
  truths:
    - "ExecutionLog stores execution records in KV when native-v2 feature is enabled"
    - "Execution history persists across magellan runs"
    - "Existing ExecutionLog API remains unchanged (log_execution, get_recent, get_by_id)"
    - "Unit tests verify KV-based execution log storage"
  artifacts:
    - path: "src/graph/execution_log.rs"
      provides: "KV-backed execution audit trail"
      contains: "ExecutionLog with kv_backend field"
      min_lines: 120
  key_links:
    - from: "src/graph/execution_log.rs"
      to: "src/kv/keys.rs"
      via: "execution_log_key for record lookups"
      pattern: "crate::kv::keys::execution_log_key"
    - from: "src/graph/execution_log.rs"
      to: "src/kv/encoding.rs"
      via: "encode_json/decode_json for record serialization"
      pattern: "crate::kv::encoding::(encode_json|decode_json)"
---

<objective>
Replace ExecutionLog's :memory: stub with proper KV store storage in native-v2 mode.

Purpose: Enable persistent execution history for audit trails and debugging without losing data on exit.

Output: ExecutionLog stores records in KV store (native-v2) or SQLite (default) via conditional compilation.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-eliminate-native-v2-stubs/52-RESEARCH.md
@.planning/phases/52-eliminate-native-v2-stubs/52-01-SUMMARY.md

@src/graph/execution_log.rs
@src/kv/keys.rs
@src/kv/encoding.rs
@src/kv/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Modify ExecutionLog to support KV backend</name>
  <files>src/graph/execution_log.rs</files>
  <action>
Modify src/graph/execution_log.rs to add KV-backed storage for native-v2 mode:

1. Add new field to ExecutionLog struct (after line 35, in the struct definition):
   ```rust
   #[cfg(feature = "native-v2")]
   kv_backend: Option<Rc<dyn sqlitegraph::GraphBackend>>,
   ```

2. Add new constructor for KV-backed ExecutionLog (after line 57, after disabled()):
   ```rust
   #[cfg(feature = "native-v2")]
   pub fn with_kv_backend(backend: Rc<dyn sqlitegraph::GraphBackend>) -> Self {
       Self {
           db_path: std::path::PathBuf::from(":memory:"),
           kv_backend: Some(backend),
       }
   }
   ```

3. Modify log_execution() method (around line 80) to use KV when available:
   - Check if kv_backend is Some
   - If yes: encode ExecutionRecord to JSON, use backend.kv_set(execution_log_key(id), KvValue::Json(json))
   - If no: use existing SQLite logic

4. Modify get_recent() method (around line 120) to use KV when available:
   - If kv_backend is Some: query KV via prefix scan (execlog:* keys)
   - Decode JSON records, sort by started_at, limit to N
   - If no: use existing SQLite logic

5. Modify get_by_id() method to use KV when available:
   - Use backend.kv_get(execution_log_key(id))
   - Decode JSON if found

DO NOT:
- Remove SQLite support (keep dual-mode for backward compatibility)
- Modify the public API
- Change db_path field (keep for SQLite mode)
  </action>
  <verify>
cargo test --package magellan --lib execution_log::tests::test_execution_log_kv
  </verify>
  <done>
ExecutionLog has KV storage for execution records in native-v2 mode, with unit tests proving persistence.
  </done>
</task>

<task type="auto">
  <name>Add unit tests for KV-backed ExecutionLog</name>
  <files>src/graph/execution_log.rs</files>
  <action>
Add unit tests to verify KV-backed execution log storage:

1. test_execution_log_kv_roundtrip:
   - Create test backend with NativeGraphBackend::in_memory()
   - Create ExecutionLog with with_kv_backend()
   - Log execution via log_execution()
   - Retrieve via get_by_id()
   - Verify fields match

2. test_execution_log_kv_persistence:
   - Log execution, drop ExecutionLog
   - Create new ExecutionLog with same backend
   - Verify record is retrievable

3. test_execution_log_kv_recent:
   - Log 5 executions with different timestamps
   - Call get_recent(3)
   - Verify 3 most recent returned

Add these tests to the #[cfg(test)] mod tests block.

DO NOT:
- Remove existing SQLite-based tests
- Modify ExecutionRecord struct (already has serde derives from 52-01)
  </action>
  <verify>
cargo test --package magellan --lib execution_log::tests
  </verify>
  <done>
All execution log tests pass, including KV round-trip and persistence tests.
  </done>
</task>

</tasks>

<verification>
1. cargo test --package magellan --lib execution_log::tests passes
2. cargo check --features native-v2 completes without errors
3. Code inspection confirms execution records use KV storage when native-v2 is enabled
4. Execution history persists across ExecutionLog instances
</verification>

<success_criteria>
- ExecutionLog uses KV for storage in native-v2 mode
- Execution records persist across instances
- All existing tests still pass
- Zero compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/52-eliminate-native-v2-stubs/52-03-SUMMARY.md` with:
- ExecutionLog modified to support KV backend
- New constructor: with_kv_backend()
- Modified methods: log_execution(), get_recent(), get_by_id()
- Tests added: test_execution_log_kv_roundtrip, test_execution_log_kv_persistence, test_execution_log_kv_recent
- Test results: All pass
</output>
