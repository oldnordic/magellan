---
phase: 52-eliminate-native-v2-stubs
plan: 05
type: execute
wave: 3
depends_on: ["52-01", "52-02"]
files_modified:
  - src/graph/cfg_extractor.rs
  - src/generation/mod.rs
autonomous: true

must_haves:
  truths:
    - "CFG blocks are stored in KV when native-v2 feature is enabled"
    - "CFG extraction returns actual blocks instead of empty vectors"
    - "Existing CFG API remains unchanged (extract_cfg_from_ast, get_cfg_for_function)"
    - "Unit tests verify KV-based CFG storage"
  artifacts:
    - path: "src/graph/cfg_extractor.rs"
      provides: "KV-backed CFG block storage"
      contains: "store_cfg_blocks_kv, get_cfg_blocks_kv functions"
      min_lines: 850
  key_links:
    - from: "src/graph/cfg_extractor.rs"
      to: "src/kv/keys.rs"
      via: "cfg_blocks_key for CFG lookups"
      pattern: "crate::kv::keys::cfg_blocks_key"
    - from: "src/graph/cfg_extractor.rs"
      to: "src/kv/encoding.rs"
      via: "encode_cfg_blocks/decode_cfg_blocks"
      pattern: "crate::kv::encoding::(encode_cfg_blocks|decode_cfg_blocks)"
    - from: "src/generation/mod.rs"
      to: "src/graph/cfg_extractor.rs"
      via: "CFG storage integration with ChunkStore"
      pattern: "cfg_extractor::store_cfg_blocks_kv"
---

<objective>
Replace CFG extraction's empty stub return with proper KV store storage in native-v2 mode.

Purpose: Enable persistent CFG block storage for control flow analysis without losing data on exit.

Output: CFG blocks stored in KV store (native-v2) or SQLite (default) via conditional compilation.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-eliminate-native-v2-stubs/52-RESEARCH.md
@.planning/phases/52-eliminate-native-v2-stubs/52-01-SUMMARY.md
@.planning/phases/52-eliminate-native-v2-stubs/52-02-SUMMARY.md

@src/graph/cfg_extractor.rs
@src/generation/mod.rs
@src/kv/keys.rs
@src/kv/encoding.rs
@src/kv/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Add KV storage functions to cfg_extractor module</name>
  <files>src/graph/cfg_extractor.rs</files>
  <action>
Add KV-backed storage functions to src/graph/cfg_extractor.rs:

1. Add store_cfg_blocks_kv() function (after line 700, before llvm_cfg module):
   ```rust
   #[cfg(feature = "native-v2")]
   pub fn store_cfg_blocks_kv(
       backend: Rc<dyn sqlitegraph::GraphBackend>,
       function_id: i64,
       blocks: &[CfgBlock],
   ) -> Result<()> {
       use crate::kv::keys::cfg_blocks_key;
       use crate::kv::encoding::encode_cfg_blocks;

       let key = cfg_blocks_key(function_id);
       let encoded = encode_cfg_blocks(blocks)?;
       backend.kv_set(key, sqlitegraph::backend::KvValue::Bytes(encoded), None)?;
       Ok(())
   }
   ```

2. Add get_cfg_blocks_kv() function:
   ```rust
   #[cfg(feature = "native-v2")]
   pub fn get_cfg_blocks_kv(
       backend: &dyn sqlitegraph::GraphBackend,
       function_id: i64,
   ) -> Result<Vec<CfgBlock>> {
       use crate::kv::keys::cfg_blocks_key;
       use crate::kv::encoding::decode_cfg_blocks;

       let key = cfg_blocks_key(function_id);
       let snapshot = sqlitegraph::SnapshotId::current();

       match backend.kv_get(snapshot, &key)? {
           Some(sqlitegraph::backend::KvValue::Bytes(data)) => {
               decode_cfg_blocks(&data)
           }
           _ => Ok(vec![]),
       }
   }
   ```

3. Modify RustCfgExtractor::extract_cfg() to store blocks in KV (around line 650):
   - Add backend parameter to extract_cfg()
   - After extracting blocks, call store_cfg_blocks_kv() if native-v2 is enabled
   - Return the blocks

DO NOT:
- Modify the CFG extraction logic itself (only add storage)
- Remove SQLite storage path (keep dual-mode)
- Change CfgBlock struct (already has serde derives from 52-01)
  </action>
  <verify>
cargo test --package magellan --lib cfg_extractor::tests::test_cfg_storage_kv
  </verify>
  <done>
CFG extractor has KV storage for blocks in native-v2 mode, with unit tests proving functionality.
  </done>
</task>

<task type="auto">
  <name>Integrate CFG storage with ChunkStore</name>
  <files>src/generation/mod.rs</files>
<action>
Update src/generation/mod.rs to integrate CFG storage with ChunkStore:

1. Modify ChunkStore struct to include CFG storage methods (around line 200):
   - Add store_cfg_blocks() method that delegates to cfg_extractor::store_cfg_blocks_kv
   - Add get_cfg_blocks() method that delegates to cfg_extractor::get_cfg_blocks_kv

2. Update ChunkStore constructors to accept backend for CFG storage:
   - with_kv_backend() already has backend, use it for CFG too
   - in_memory() should pass backend to CFG functions

DO NOT:
- Modify existing chunk storage logic (Plan 02)
- Change the public API signature
  </action>
  <verify>
cargo test --package magellan --lib generation::tests::test_cfg_integration
  </verify>
  <done>
ChunkStore integrates CFG storage with KV backend in native-v2 mode.
  </done>
</task>

<task type="auto">
  <name>Add unit tests for KV-backed CFG storage</name>
  <files>src/graph/cfg_extractor.rs</files>
  <action>
Add unit tests to verify KV-backed CFG storage:

1. test_cfg_storage_kv_roundtrip:
   - Create test backend
   - Create sample CfgBlock vector
   - Store via store_cfg_blocks_kv()
   - Retrieve via get_cfg_blocks_kv()
   - Verify all blocks match

2. test_cfg_storage_kv_empty:
   - Try to get CFG for non-existent function
   - Verify empty vector returned

3. test_cfg_storage_kv_overwrite:
   - Store initial CFG blocks
   - Store updated CFG blocks for same function
   - Verify latest blocks are returned

Add these tests to the #[cfg(test)] mod tests block in cfg_extractor.rs.

DO NOT:
- Remove existing AST-based CFG extraction tests
- Modify actual extraction logic (storage only)
  </action>
  <verify>
cargo test --package magellan --lib cfg_extractor::tests
  </verify>
  <done>
All CFG storage tests pass, including KV round-trip and overwrite tests.
  </done>
</task>

</tasks>

<verification>
1. cargo test --package magellan --lib cfg_extractor::tests passes
2. cargo check --features native-v2 completes without errors
3. Code inspection confirms CFG blocks use KV storage when native-v2 is enabled
4. CFG extraction returns actual blocks instead of empty vectors
</verification>

<success_criteria>
- CFG blocks stored in KV in native-v2 mode
- CFG extraction returns actual blocks
- All existing tests still pass
- Zero compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/52-eliminate-native-v2-stubs/52-05-SUMMARY.md` with:
- CFG extractor modified to support KV backend
- New functions: store_cfg_blocks_kv(), get_cfg_blocks_kv()
- ChunkStore integration: store_cfg_blocks(), get_cfg_blocks()
- Tests added: test_cfg_storage_kv_roundtrip, test_cfg_storage_kv_empty, test_cfg_storage_kv_overwrite
- Test results: All pass
</output>
