---
phase: 52-eliminate-native-v2-stubs
plan: 07
type: execute
wave: 4
depends_on: ["52-02", "52-03", "52-04", "52-05", "52-06"]
files_modified:
  - tests/backend_migration_tests.rs
  - tests/kv_storage_tests.rs
autonomous: true

must_haves:
  truths:
    - "All tests pass with native-v2 feature enabled"
    - "Round-trip migration test demonstrates data preservation"
    - "Performance benchmarks show KV vs SQLite comparison"
    - "Concurrent access test verifies thread safety"
    - "Integration test demonstrates full metadata lifecycle"
  artifacts:
    - path: "tests/backend_migration_tests.rs"
      provides: "End-to-end migration verification"
      contains: "test_round_trip_migration_with_metadata"
      min_lines: 500
    - path: "tests/kv_storage_tests.rs"
      provides: "KV storage integration tests"
      contains: "test_concurrent_kv_access, test_metadata_lifecycle"
      min_lines: 400
  key_links:
    - from: "tests/backend_migration_tests.rs"
      to: "src/migrate_backend_cmd.rs"
      via: "Migration command verification"
      pattern: "migrate_backend_cmd::run_migrate_backend"
    - from: "tests/kv_storage_tests.rs"
      to: "src/kv/mod.rs"
      via: "KV storage API verification"
      pattern: "kv::(populate_symbol_index|invalidate_file_index)"
---

<objective>
Verify end-to-end functionality of KV-backed metadata storage with comprehensive testing and performance benchmarks.

Purpose: Ensure all stub replacements work correctly, data persists across migrations, and performance meets expectations.

Output: Comprehensive test suite demonstrating full feature parity between SQLite and KV storage modes.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-eliminate-native-v2-stubs/52-RESEARCH.md
@.planning/phases/52-eliminate-native-v2-stubs/52-01-SUMMARY.md
@.planning/phases/52-eliminate-native-v2-stubs/52-02-SUMMARY.md
@.planning/phases/52-eliminate-native-v2-stubs/52-03-SUMMARY.md
@.planning/phases/52-eliminate-native-v2-stubs/52-04-SUMMARY.md
@.planning/phases/52-eliminate-native-v2-stubs/52-05-SUMMARY.md
@.planning/phases/52-eliminate-native-v2-stubs/52-06-SUMMARY.md

@tests/backend_migration_tests.rs
@src/kv/mod.rs
@src/generation/mod.rs
@src/graph/execution_log.rs
@src/graph/metrics/mod.rs
@src/graph/cfg_extractor.rs
@src/graph/ast_extractor.rs
@src/migrate_backend_cmd.rs
</context>

<tasks>

<task type="auto">
  <name>Add round-trip migration test with metadata</name>
  <files>tests/backend_migration_tests.rs</files>
  <action>
Add comprehensive round-trip migration test to tests/backend_migration_tests.rs:

1. test_round_trip_migration_with_metadata():
   - Create SQLite database with sample data:
     * Index a few test files (create symbols, references, calls)
     * Store chunks via ChunkStore
     * Log executions via ExecutionLog
     * Compute metrics via MetricsOps
     * Extract AST nodes and CFG blocks
   - Run migrate-backend to Native V2
   - Verify all data transferred:
     * Graph data (nodes, edges) via snapshot counts
     * Chunks via KV lookup
     * Execution logs via KV lookup
     * Metrics via KV lookup
     * AST nodes via KV lookup
     * CFG blocks via KV lookup
   - Run migrate-backend back to SQLite
   - Verify data preserved in SQLite

2. test_migration_preserves_chunk_content():
   - Create chunk with multi-byte UTF-8 content
   - Migrate to Native V2
   - Verify byte-identical content via KV lookup
   - Migrate back to SQLite
   - Verify content unchanged

3. test_migration_preserves_execution_history():
   - Log 10 executions with different timestamps
   - Migrate to Native V2
   - Verify get_recent(5) returns correct 5
   - Migrate back to SQLite
   - Verify all 10 executions present

DO NOT:
- Modify existing migration tests (add new tests only)
- Use hardcoded temp file paths (use tempfile crate)
- Skip verification steps (every data type must be verified)
  </action>
  <verify>
cargo test --package magellan --test backend_migration_tests --features native-v2 -- --test-threads=1
  </verify>
  <done>
Round-trip migration tests pass, verifying all metadata preserved across SQLite -> KV -> SQLite.
  </done>
</task>

<task type="auto">
  <name>Add concurrent KV access test</name>
  <files>tests/kv_storage_tests.rs</files>
  <action>
Create new integration test file tests/kv_storage_tests.rs with concurrent access test:

1. test_concurrent_kv_access():
   - Create NativeGraphBackend with in-memory storage
   - Spawn 10 threads, each:
     * Stores 100 chunks with unique keys
     * Stores 100 execution records
     * Stores 100 file metrics
   - Join all threads
   - Verify 1000 chunks stored (10 threads x 100)
   - Verify 1000 execution records stored
   - Verify 1000 file metrics stored
   - Use Arc&lt;Mutex&lt;Vec&lt;Result&gt;&gt;&gt; to collect thread results

2. test_kv_write_read_contention():
   - Create backend
   - Spawn writer thread: continuously write chunks
   - Spawn reader thread: continuously read chunks
   - Run for 1 second
   - Verify no deadlocks or panics
   - Verify reads return consistent data

3. test_metadata_lifecycle():
   - Create fresh NativeGraphBackend
   - Index a test file (create symbols)
   - Store chunk for a symbol
   - Compute metrics for file
   - Log execution
   - Extract AST nodes
   - Extract CFG blocks
   - Verify all retrievable via KV
   - Delete file (invalidate index)
   - Verify KV entries cleaned up

Use rayon for threading if available, otherwise std::thread.

DO NOT:
- Use SQLite backend (this is KV-specific testing)
- Skip cleanup verification
- Ignore thread panic results
  </action>
  <verify>
cargo test --package magellan --test kv_storage_tests --features native-v2 -- --test-threads=1
  </verify>
  <done>
Concurrent access tests pass, demonstrating thread-safe KV operations.
  </done>
</task>

<task type="auto">
  <name>Add performance benchmark comparing KV vs SQLite</name>
  <files>benches/metadata_bench.rs</files>
  <action>
Create benchmark suite benches/metadata_bench.rs:

1. bench_chunk_storage_sqlite():
   - Time storing 1000 chunks in SQLite
   - Use Criterion for accurate measurement

2. bench_chunk_storage_kv():
   - Time storing 1000 chunks in KV
   - Use identical chunk data

3. bench_execution_log_sqlite():
   - Time logging 1000 executions in SQLite

4. bench_execution_log_kv():
   - Time logging 1000 executions in KV

5. bench_metrics_sqlite():
   - Time computing and storing 1000 file metrics in SQLite

6. bench_metrics_kv():
   - Time computing and storing 1000 file metrics in KV

Add Criterion harness configuration to Cargo.toml:
```toml
[[bench]]
name = "metadata_bench"
harness = false
required-features = ["native-v2"]
```

Run benchmarks with: cargo bench --features native-v2

DO NOT:
- Use real production data (generate synthetic test data)
- Skip warmup iterations (Criterion handles this)
- Benchmark graph operations (metadata only)
  </action>
  <verify>
cargo bench --features native-v2 -- metadata_bench
  </verify>
  <done>
Performance benchmarks run successfully, showing KV vs SQLite comparison for all metadata types.
  </done>
</task>

<task type="auto">
  <name>Run full test suite and fix any failures</name>
  <files>tests/, src/</files>
  <action>
Run complete test suite with native-v2 feature and fix any failures:

1. Run unit tests:
   ```bash
   cargo test --lib --features native-v2
   ```

2. Run integration tests:
   ```bash
   cargo test --test '*' --features native-v2
   ```

3. Fix any test failures:
   - If test uses SQLite-specific assertions, add KV path
   - If test expects temp database files, update for KV mode
   - If test has race conditions, add proper synchronization
   - If test fails due to missing data, verify KV migration occurred

4. Document test failures in SUMMARY.md if any remain (with reasoning)

DO NOT:
- Disable tests without documenting why
- Modify test logic to make it pass (fix implementation instead)
- Skip integration tests
  </action>
  <verify>
cargo test --all-targets --features native-v2
  </verify>
  <done>
All tests pass with native-v2 feature enabled (or failures documented with acceptable reasoning).
  </done>
</task>

</tasks>

<verification>
1. cargo test --all-targets --features native-v2 passes (or failures documented)
2. Round-trip migration test demonstrates byte-identical data preservation
3. Concurrent access test completes without deadlocks or data loss
4. Performance benchmarks produce measurable results
5. Manual smoke test: Index a real codebase, verify metadata persists
</verification>

<success_criteria>
- All new tests pass
- Round-trip migration verified
- Concurrent access safe
- Performance baseline established
- Zero test failures without documented justification
</success_criteria>

<output>
After completion, create `.planning/phases/52-eliminate-native-v2-stubs/52-07-SUMMARY.md` with:
- Tests added: test_round_trip_migration_with_metadata, test_concurrent_kv_access, test_metadata_lifecycle
- Benchmark suite created: benches/metadata_bench.rs
- Test results: All pass (X/Y tests passing)
- Performance results: KV vs SQLite comparison table
- Remaining issues: Any test failures with justification
</output>
