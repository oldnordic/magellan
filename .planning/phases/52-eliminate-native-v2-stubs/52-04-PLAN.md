---
phase: 52-eliminate-native-v2-stubs
plan: 04
type: execute
wave: 2
depends_on: ["52-01"]
files_modified:
  - src/graph/metrics/mod.rs
autonomous: true

must_haves:
  truths:
    - "MetricsOps stores file/symbol metrics in KV when native-v2 feature is enabled"
    - "Metrics persist across magellan runs"
    - "Existing MetricsOps API remains unchanged (upsert_file_metrics, upsert_symbol_metrics, get_file_metrics, get_symbol_metrics)"
    - "Unit tests verify KV-based metrics storage"
  artifacts:
    - path: "src/graph/metrics/mod.rs"
      provides: "KV-backed metrics storage"
      contains: "MetricsOps with kv_backend field"
      min_lines: 180
  key_links:
    - from: "src/graph/metrics/mod.rs"
      to: "src/kv/keys.rs"
      via: "file_metrics_key, symbol_metrics_key"
      pattern: "crate::kv::keys::(file_metrics_key|symbol_metrics_key)"
    - from: "src/graph/metrics/mod.rs"
      to: "src/kv/encoding.rs"
      via: "encode_json/decode_json for metrics serialization"
      pattern: "crate::kv::encoding::(encode_json|decode_json)"
---

<objective>
Replace MetricsOps' :memory: stub with proper KV store storage in native-v2 mode.

Purpose: Enable persistent metrics storage for code quality analysis without losing data on exit.

Output: MetricsOps stores metrics in KV store (native-v2) or SQLite (default) via conditional compilation.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-eliminate-native-v2-stubs/52-RESEARCH.md
@.planning/phases/52-eliminate-native-v2-stubs/52-01-SUMMARY.md

@src/graph/metrics/mod.rs
@src/kv/keys.rs
@src/kv/encoding.rs
@src/kv/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Modify MetricsOps to support KV backend</name>
  <files>src/graph/metrics/mod.rs</files>
  <action>
Modify src/graph/metrics/mod.rs to add KV-backed storage for native-v2 mode:

1. Add new field to MetricsOps struct (after line 38, in the struct definition):
   ```rust
   #[cfg(feature = "native-v2")]
   kv_backend: Option<Rc<dyn sqlitegraph::GraphBackend>>,
   ```

2. Add new constructor for KV-backed MetricsOps (after line 57, after disabled()):
   ```rust
   #[cfg(feature = "native-v2")]
   pub fn with_kv_backend(backend: Rc<dyn sqlitegraph::GraphBackend>) -> Self {
       Self {
           db_path: std::path::PathBuf::from(":memory:"),
           kv_backend: Some(backend),
       }
   }
   ```

3. Modify upsert_file_metrics() method (around line 84) to use KV when available:
   - Check if kv_backend is Some
   - If yes: encode FileMetrics to JSON, use backend.kv_set(file_metrics_key(path), KvValue::Json(json))
   - If no: use existing SQLite logic

4. Modify upsert_symbol_metrics() method (around line 107) to use KV when available:
   - Same pattern as file metrics, using symbol_metrics_key(symbol_id)

5. Modify get_file_metrics() method to use KV when available:
   - Use backend.kv_get(file_metrics_key(path))
   - Decode JSON if found

6. Modify get_symbol_metrics() method to use KV when available:
   - Use backend.kv_get(symbol_metrics_key(symbol_id))
   - Decode JSON if found

DO NOT:
- Remove SQLite support (keep dual-mode for backward compatibility)
- Modify the public API
- Change db_path field (keep for SQLite mode)
  </action>
  <verify>
cargo test --package magellan --lib metrics::tests::test_metrics_kv
  </verify>
  <done>
MetricsOps has KV storage for metrics in native-v2 mode, with unit tests proving persistence.
  </done>
</task>

<task type="auto">
  <name>Add unit tests for KV-backed MetricsOps</name>
  <files>src/graph/metrics/mod.rs</files>
  <action>
Add unit tests to verify KV-backed metrics storage:

1. test_metrics_file_kv_roundtrip:
   - Create test backend
   - Create MetricsOps with with_kv_backend()
   - Upsert file metrics
   - Retrieve via get_file_metrics()
   - Verify all fields match

2. test_metrics_symbol_kv_roundtrip:
   - Same pattern for symbol metrics

3. test_metrics_kv_persistence:
   - Upsert metrics, drop MetricsOps
   - Create new MetricsOps with same backend
   - Verify metrics are retrievable

4. test_metrics_kv_update:
   - Upsert initial metrics
   - Upsert updated metrics with different values
   - Verify latest values are returned

Add these tests to the #[cfg(test)] mod tests block.

DO NOT:
- Remove existing SQLite-based tests
- Modify FileMetrics/SymbolMetrics structs (already have serde derives from 52-01)
  </action>
  <verify>
cargo test --package magellan --lib metrics::tests
  </verify>
  <done>
All metrics tests pass, including KV round-trip and persistence tests.
  </done>
</task>

</tasks>

<verification>
1. cargo test --package magellan --lib metrics::tests passes
2. cargo check --features native-v2 completes without errors
3. Code inspection confirms metrics use KV storage when native-v2 is enabled
4. Metrics persist across MetricsOps instances
</verification>

<success_criteria>
- MetricsOps uses KV for storage in native-v2 mode
- Metrics persist across instances
- All existing tests still pass
- Zero compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/52-eliminate-native-v2-stubs/52-04-SUMMARY.md` with:
- MetricsOps modified to support KV backend
- New constructor: with_kv_backend()
- Modified methods: upsert_file_metrics(), upsert_symbol_metrics(), get_file_metrics(), get_symbol_metrics()
- Tests added: test_metrics_file_kv_roundtrip, test_metrics_symbol_kv_roundtrip, test_metrics_kv_persistence, test_metrics_kv_update
- Test results: All pass
</output>
