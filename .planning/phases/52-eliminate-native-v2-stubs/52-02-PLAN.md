---
phase: 52-eliminate-native-v2-stubs
plan: 02
type: execute
wave: 2
depends_on: ["52-01"]
files_modified:
  - src/generation/mod.rs
autonomous: true

must_haves:
  truths:
    - "ChunkStore uses KV storage for code_chunks when native-v2 feature is enabled"
    - "Chunks persist across process restarts (no temp database files)"
    - "Existing ChunkStore API remains unchanged (get_by_span, get_by_symbol, store)"
    - "Unit tests verify KV-based chunk storage and retrieval"
  artifacts:
    - path: "src/generation/mod.rs"
      provides: "KV-backed ChunkStore for native-v2 mode"
      contains: "ChunkStore struct with kv_backend field"
      min_lines: 184
  key_links:
    - from: "src/generation/mod.rs"
      to: "src/kv/keys.rs"
      via: "chunk_key function for chunk lookups"
      pattern: "crate::kv::keys::chunk_key"
    - from: "src/generation/mod.rs"
      to: "src/kv/encoding.rs"
      via: "encode_json/decode_json for chunk serialization"
      pattern: "crate::kv::encoding::(encode_json|decode_json)"
---

<objective>
Replace ChunkStore's temporary SQLite stub with proper KV store storage in native-v2 mode.

Purpose: Enable persistent code chunk storage for code generation features without using temporary databases that lose data on exit.

Output: ChunkStore stores chunks in KV store (native-v2) or SQLite (default) via conditional compilation.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-eliminate-native-v2-stubs/52-RESEARCH.md
@.planning/phases/52-eliminate-native-v2-stubs/52-01-SUMMARY.md

@src/generation/mod.rs
@src/kv/keys.rs
@src/kv/encoding.rs
@src/kv/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Modify ChunkStore to support KV backend</name>
  <files>src/generation/mod.rs</files>
  <action>
Modify src/generation/mod.rs to add KV-backed storage for native-v2 mode:

1. Add new field to ChunkStore struct (after line 60, in the struct definition):
   ```rust
   #[cfg(feature = "native-v2")]
   kv_backend: Option<Rc<dyn sqlitegraph::GraphBackend>>,
   ```

2. Add new constructor for KV-backed ChunkStore (after line 74, after with_connection):
   ```rust
   #[cfg(feature = "native-v2")]
   pub fn with_kv_backend(backend: Rc<dyn sqlitegraph::GraphBackend>) -> Self {
       Self {
           conn_source: ChunkStoreConnection::Owned(PathBuf::from(":memory:")),
           kv_backend: Some(backend),
       }
   }
   ```

3. Modify in_memory() to use KV backend if provided (replace lines 82-184):
   - Keep the temp file fallback for backward compatibility
   - Add kv_backend parameter: pub fn in_memory(kv_backend: Option<Rc<dyn GraphBackend>>) -> Self
   - Store kv_backend in the struct field

4. Modify get_connection() method to handle KV backend (around line 187):
   - If kv_backend is Some, return a special SQLite connection with just the schema
   - Otherwise, use existing logic

5. Update store(), get_by_span(), get_by_symbol() to use KV when available:
   - store(): Use backend.kv_set(chunk_key(...), KvValue::Json(serde_json::to_string(chunk)?))
   - get_by_span(): Use backend.kv_get(chunk_key(...)) then decode_json
   - get_by_symbol(): Query file:sym:{file_id} KV to get chunks in file

DO NOT:
- Remove SQLite support (keep dual-mode for backward compatibility)
- Modify the public API (existing callers must work unchanged)
- Change AST/CFG storage (handled in later plans)
  </action>
  <verify>
cargo test --package magellan --lib generation::tests::test_chunk_store_kv
  </verify>
  <done>
ChunkStore has KV storage for chunks in native-v2 mode, with unit tests proving persistence.
  </done>
</task>

<task type="auto">
  <name>Add unit tests for KV-backed ChunkStore</name>
  <files>src/generation/mod.rs</files>
  <action>
Add unit tests to the generation module to verify KV-backed chunk storage:

1. test_chunk_store_kv_roundtrip:
   - Create a test backend with sqlitegraph::NativeGraphBackend::in_memory()
   - Create ChunkStore with with_kv_backend()
   - Store a CodeChunk via store()
   - Retrieve it via get_by_span()
   - Verify content matches

2. test_chunk_store_kv_persistence:
   - Store chunk, drop ChunkStore
   - Create new ChunkStore with same backend
   - Verify chunk is still retrievable

3. test_chunk_store_kv_by_symbol:
   - Store multiple chunks for same file
   - Query via get_by_symbol()
   - Verify correct chunks returned

Add these tests to the #[cfg(test)] mod tests block.

DO NOT:
- Remove existing SQLite-based tests
- Create integration tests (unit tests only for this plan)
  </action>
  <verify>
cargo test --package magellan --lib generation::tests
  </verify>
  <done>
All chunk storage tests pass, including KV round-trip and persistence tests.
  </done>
</task>

</tasks>

<verification>
1. cargo test --package magellan --lib generation::tests passes
2. cargo check --features native-v2 completes without errors
3. Code inspection confirms chunks use KV storage when native-v2 is enabled
4. No temporary database files created in native-v2 mode
</verification>

<success_criteria>
- ChunkStore uses KV for chunk storage in native-v2 mode
- Chunks persist across ChunkStore instances
- All existing tests still pass
- Zero compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/52-eliminate-native-v2-stubs/52-02-SUMMARY.md` with:
- ChunkStore modified to support KV backend
- New constructor: with_kv_backend()
- Modified methods: store(), get_by_span(), get_by_symbol()
- Tests added: test_chunk_store_kv_roundtrip, test_chunk_store_kv_persistence, test_chunk_store_kv_by_symbol
- Test results: All pass
</output>
