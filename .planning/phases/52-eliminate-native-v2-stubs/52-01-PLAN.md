---
phase: 52-eliminate-native-v2-stubs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/kv/keys.rs
  - src/kv/encoding.rs
autonomous: true

must_haves:
  truths:
    - "New KV key patterns exist for chunks, execution logs, metrics, AST nodes, and CFG blocks"
    - "Encoding functions exist for complex types (CodeChunk, ExecutionRecord, Metrics)"
    - "Unit tests verify key format correctness and encoding round-trips"
    - "Key namespaces do not collide with existing sym: and file: patterns"
  artifacts:
    - path: "src/kv/keys.rs"
      provides: "KV key construction for metadata storage"
      exports: ["chunk_key", "execution_log_key", "file_metrics_key", "symbol_metrics_key", "cfg_blocks_key", "ast_nodes_key"]
      min_lines: 234
    - path: "src/kv/encoding.rs"
      provides: "Encoding/decoding for metadata types"
      exports: ["encode_code_chunk", "decode_code_chunk", "encode_execution_record", "decode_execution_record", "encode_file_metrics", "decode_file_metrics"]
      min_lines: 129
  key_links:
    - from: "src/kv/keys.rs"
      to: "src/kv/encoding.rs"
      via: "Key functions used by encoding functions"
      pattern: "format!.*into_bytes"
---

<objective>
Create KV key patterns and encoding functions for all metadata types that will be stored in the Native V2 backend.

Purpose: Establish the foundational key namespace and encoding layer before implementing actual storage in later plans. This plan is pure infrastructure with no backend integration yet.

Output: Extended src/kv/keys.rs and src/kv/encoding.rs with new functions for chunks, execution logs, metrics, AST nodes, and CFG blocks.
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-eliminate-native-v2-stubs/52-RESEARCH.md

@src/kv/keys.rs
@src/kv/encoding.rs
@src/generation/mod.rs
@src/graph/execution_log.rs
@src/graph/metrics/mod.rs
@src/graph/cfg_extractor.rs
</context>

<tasks>

<task type="auto">
  <name>Add KV key patterns for metadata storage</name>
  <files>src/kv/keys.rs</files>
  <action>
Add the following key construction functions to src/kv/keys.rs after line 152 (after sym_fqn_of_key):

1. chunk_key(file_path: &str, byte_start: usize, byte_end: usize) -> Vec<u8>
   - Format: "chunk:{file_path}:{byte_start}:{byte_end}"
   - Use file_path.replace(':', "::") to avoid colon collisions in paths
   - Example: "chunk:src/main.rs::100:200"

2. execution_log_key(execution_id: &str) -> Vec<u8>
   - Format: "execlog:{execution_id}"
   - Example: "execlog:550e8400-e29b-41d4-a716-446655440000"

3. file_metrics_key(file_path: &str) -> Vec<u8>
   - Format: "metrics:file:{file_path}"
   - Use file_path.replace(':', "::") for path escaping

4. symbol_metrics_key(symbol_id: i64) -> Vec<u8>
   - Format: "metrics:symbol:{symbol_id}"

5. cfg_blocks_key(function_id: i64) -> Vec<u8>
   - Format: "cfg:func:{function_id}"

6. ast_nodes_key(file_id: u64) -> Vec<u8>
   - Format: "ast:file:{file_id}"

Follow the existing pattern: format!().into_bytes() with proper documentation.

DO NOT:
- Create any actual storage logic (that's Plan 02-06)
- Modify existing key functions (sym_fqn_key, etc.)
- Add feature gates (entire module is already cfg(feature = "native-v2"))
  </action>
  <verify>
cargo test --package magellan --lib kv::keys::tests
  </verify>
  <done>
All 6 new key functions exist with correct signatures and pass unit tests for format verification.
  </done>
</task>

<task type="auto">
  <name>Add encoding functions for metadata types</name>
  <files>src/kv/encoding.rs</files>
  <action>
Add the following encoding/decoding functions to src/kv/encoding.rs after line 128 (after decode_symbol_ids):

For JSON-serializable types (CodeChunk, ExecutionRecord, FileMetrics, SymbolMetrics):
1. encode_json&lt;T: serde::Serialize&gt;(value: &T) -> Result&lt;Vec&lt;u8&gt;&gt;
   - Use serde_json::to_vec(value)
   - Return anyhow::Result

2. decode_json&lt;T: serde::de::DeserializeOwned&gt;(bytes: &[u8]) -> Result&lt;T&gt;
   - Use serde_json::from_slice(bytes)
   - Return anyhow::Result

For CFG blocks (Vec&lt;CfgBlock&gt;):
3. encode_cfg_blocks(blocks: &[CfgBlock]) -> Result&lt;Vec&lt;u8&gt;&gt;
   - Delegate to encode_json (CFG blocks are JSON-serializable)

4. decode_cfg_blocks(bytes: &[u8]) -> Result&lt;Vec&lt;CfgBlock&gt;&gt;
   - Delegate to decode_json

For AST nodes (Vec&lt;AstNode&gt;):
5. encode_ast_nodes(nodes: &[AstNode]) -> Result&lt;Vec&lt;u8&gt;&gt;
   - Delegate to encode_json

6. decode_ast_nodes(bytes: &[u8]) -> Result&lt;Vec&lt;AstNode&gt;&gt;
   - Delegate to decode_json

Add unit tests for JSON encoding round-trip in the tests module.

DO NOT:
- Create custom binary encoding (JSON is sufficient for metadata)
- Modify existing encode_symbol_ids/decode_symbol_ids functions
- Add direct database storage logic
  </action>
  <verify>
cargo test --package magellan --lib kv::encoding::tests
  </verify>
  <done>
All 6 encoding functions exist with correct signatures and pass round-trip tests.
  </done>
</task>

<task type="auto">
  <name>Add serde derives to metadata types</name>
  <files>src/graph/execution_log.rs, src/graph/metrics/mod.rs, src/graph/cfg_extractor.rs</files>
  <action>
Add #[derive(serde::Serialize, serde::Deserialize)] to the following structs:

1. src/graph/execution_log.rs:
   - ExecutionRecord struct (14 fields)

2. src/graph/metrics/mod.rs:
   - FileMetrics struct (8 fields)
   - SymbolMetrics struct (10 fields)

3. src/graph/cfg_extractor.rs:
   - CfgBlock struct (10 fields)

Add serde dependency to Cargo.toml if not already present (check [dependencies] section).

DO NOT:
- Modify existing struct fields (only add derives)
- Add serde to structs that already have it (check first)
- Modify any impl blocks
  </action>
  <verify>
cargo check --features native-v2
  </verify>
  <done>
All metadata structs have serde derives and cargo check passes without errors.
  </done>
</task>

</tasks>

<verification>
1. cargo test --package magellan --lib kv passes with all new tests
2. cargo check --features native-v2 completes without errors
3. Key namespace inspection confirms no collisions (grep "format!" in keys.rs shows distinct prefixes)
4. Encoding tests demonstrate successful round-trip for all types
</verification>

<success_criteria>
- 6 new key functions in keys.rs with correct format patterns
- 6 new encoding functions in encoding.rs with JSON round-trip support
- 4 metadata structs have serde derives
- All unit tests pass
- Zero compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/52-eliminate-native-v2-stubs/52-01-SUMMARY.md` with:
- Keys added: chunk_key, execution_log_key, file_metrics_key, symbol_metrics_key, cfg_blocks_key, ast_nodes_key
- Encodings added: encode_json, decode_json, encode_cfg_blocks, decode_cfg_blocks, encode_ast_nodes, decode_ast_nodes
- Serde derives added to ExecutionRecord, FileMetrics, SymbolMetrics, CfgBlock
- Test results: All KV encoding tests pass
</output>
