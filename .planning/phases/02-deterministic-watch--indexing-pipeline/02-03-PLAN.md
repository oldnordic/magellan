---
phase: 02-deterministic-watch--indexing-pipeline
plan: 03
type: execute
wave: 3
depends_on:
  - 02-02
files_modified:
  - Cargo.toml
  - src/graph/scan.rs
  - src/watch_cmd.rs
  - src/verify.rs
  - tests/ignore_rules_tests.rs
  - src/diagnostics/mod.rs
  - src/diagnostics/watch_diagnostics.rs
autonomous: true

must_haves:
  truths:
    - "User can apply include/exclude rules and Magellan deterministically skips files with explainable reasons."
    - "Per-file failures (unreadable/parse errors) do not stop watch; the failure is recorded as structured diagnostics."
  artifacts:
    - path: src/diagnostics/watch_diagnostics.rs
      provides: "Structured WatchDiagnostic (Skip|Error) records"
    - path: src/watch_cmd.rs
      provides: "Collect + surface structured diagnostics while continuing watch"
    - path: tests/ignore_rules_tests.rs
      provides: "Regression tests for include/exclude + skip reasons"
  key_links:
    - from: src/graph/scan.rs
      to: src/diagnostics/watch_diagnostics.rs
      via: "scan emits skip reasons for unsupported/excluded files"
      pattern: "SkipReason"
    - from: src/watch_cmd.rs
      to: src/diagnostics/watch_diagnostics.rs
      via: "watch pipeline records errors but continues"
      pattern: "WatchDiagnostic"
    - from: src/verify.rs
      to: src/diagnostics/watch_diagnostics.rs
      via: "verify can render diagnostics deterministically"
      pattern: "diagnostic"
---

<objective>
Add deterministic include/exclude rules and structured per-file diagnostics so users can understand what was skipped and why, and watch keeps running on bad files.

Purpose: Satisfy WATCH-03 (ignore/include/exclude + skip reasons) and WATCH-05 (per-file failures captured, watch continues).
Output: Filter policy + diagnostics types + tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-deterministic-watch--indexing-pipeline/02-RESEARCH.md

# Existing scan/watch + verify surface
@src/graph/scan.rs
@src/watch_cmd.rs
@src/verify.rs

# Upstream pipeline work
@.planning/phases/02-deterministic-watch--indexing-pipeline/02-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add structured diagnostics types and deterministic ordering</name>
  <files>
    src/diagnostics/mod.rs
    src/diagnostics/watch_diagnostics.rs
  </files>
  <action>
    - Create a small diagnostics module for Phase 2:
      - `WatchDiagnostic` enum with variants:
        - `Skipped { path: String, reason: SkipReason }`
        - `Error { path: String, stage: DiagnosticStage, message: String }`
      - `SkipReason` should cover deterministic reasons we control:
        - UnsupportedLanguage
        - ExcludedByGlob
        - IgnoredInternal (db files, target/, .git/, .codemcp/ etc. — reuse existing DB-file filter)
        - NotAFile / DirectoryEvent
      - `DiagnosticStage` should distinguish Read, Parse, IndexSymbols, IndexReferences, IndexCalls.

    - Add `impl Ord`/sorting policy (or an explicit `fn sort_key(&self)`) so diagnostics can be output deterministically:
      - Primary: path string
      - Secondary: variant/stage/reason stable key

    - IMPORTANT: No stdout/stderr contract changes in this phase; just ensure diagnostic storage and deterministic ordering. Phase 3 will formalize JSON schemas.
  </action>
  <verify>
    - cargo test -q
  </verify>
  <done>
    - Diagnostics are representable as stable, sortable data structures independent of printing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement include/exclude filtering + skip reasons in scan and watch</name>
  <files>
    Cargo.toml
    src/graph/scan.rs
    src/watch_cmd.rs
    tests/ignore_rules_tests.rs
  </files>
  <action>
    - Add include/exclude support (Phase 2 scope):
      - Keep it minimal and deterministic: use existing globset dependency.
      - Extend `watch` CLI to accept optional `--include <GLOB>` and `--exclude <GLOB>` flags (repeatable) OR a single comma-separated list.
      - Compile globs once at startup into `GlobSet`s.

    - Apply filtering consistently in both scan-initial and watcher processing:
      - For every candidate path, decide:
        1) If path is not a supported language: skip with SkipReason::UnsupportedLanguage
        2) If excluded by glob: skip with SkipReason::ExcludedByGlob
        3) If matches internal ignore list (db files, etc): skip with SkipReason::IgnoredInternal
        4) Otherwise: include and process
      - Determinism requirement: filter evaluation must not depend on iteration order; any collection of patterns must be applied in stable, documented precedence.

    - Emit structured diagnostics for skipped files:
      - During scan: accumulate diagnostics (Vec) and return them along with count.
      - During watch: record diagnostics per batch and periodically print a deterministic summary (sorted) so user can see skip reasons.

    - Add tests/ignore_rules_tests.rs with at least:
      1) Exclude pattern prevents indexing and records Skipped diagnostic with ExcludedByGlob.
      2) Unsupported file extension is skipped with UnsupportedLanguage.
      3) A parse/index error on one file does not stop indexing other files; error diagnostic is recorded.

    - Reuse existing fixture writing helpers and keep tests stable (explicit sleeps, sync writes).
  </action>
  <verify>
    - cargo test -q tests::ignore_rules_tests -- --nocapture
    - cargo test -q
  </verify>
  <done>
    - User can configure include/exclude rules and see which files were skipped and why.
    - A failing file produces a diagnostic but does not crash/stop watch pipeline.
  </done>
</task>

</tasks>

<verification>
- cargo test -q
- Run `cargo run -- watch --root . --db /tmp/magellan.db --scan-initial --exclude '**/target/**'` and confirm it doesn’t index target/ files and reports skip reasons.
</verification>

<success_criteria>
- WATCH-03 satisfied: include/exclude rules are applied deterministically and surfaced via skip diagnostics.
- WATCH-05 satisfied: per-file failures are captured as structured diagnostics and watch continues.
</success_criteria>

<output>
After completion, create `.planning/phases/02-deterministic-watch--indexing-pipeline/02-03-SUMMARY.md`
</output>
