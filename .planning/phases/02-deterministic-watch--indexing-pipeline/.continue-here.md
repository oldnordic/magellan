---
phase: 02-deterministic-watch--indexing-pipeline
task: 0
total_tasks: 3
status: planned_verified
last_updated: 2026-01-19T13:00Z
---

<current_state>

Phase 2 is PLANNED and VERIFIED. All 3 plans (02-01, 02-02, 02-03) exist with:
- Complete task breakdowns
- Design principles integrated (deterministic ordering, structured diagnostics, JSON-ready, span-aware preparation)
- SQLiteGraph API references included
- Research updated with current codebase findings
- Plans verified (passed with 3 non-blocking warnings)

Ready to execute with `/gsd:execute-phase 2`.

</current_state>

<completed_work>

- ✓ Phase 1 (Persistence Compatibility Baseline) - COMPLETE
  - All 4 plans executed
  - sqlitegraph v1.0.0 pinned
  - DB compatibility checks implemented
  - magellan_meta table added
- ✓ Codebase mapping completed - .planning/codebase/ with 7 documents
- ✓ Phase 2 CONTEXT.md created with implementation decisions
- ✓ Phase 2 RESEARCH.md completed and updated (2026-01-19)
- ✓ Phase 2 PLANS UPDATED with research findings:
  - 02-01-PLAN.md: Reconcile API (deletion primitives verified as existing)
  - 02-02-PLAN.md: Debounced batching (notify version decision checkpoint added)
  - 02-03-PLAN.md: Include/exclude + diagnostics (ignore crate dependency noted)
- ✓ Phase 2 PLANS VERIFIED - Passed with 3 warnings about Task 2 scope in 02-03

</completed_work>

<remaining_work>

Phase 2 has 3 plans to execute (Wave 1 → Wave 2 → Wave 3):
- Wave 1: 02-01-PLAN.md — Per-file reconcile + delete_file_facts (true idempotency)
- Wave 2: 02-02-PLAN.md — Debounced batching + buffer events during scan-initial (with notify version decision)
- Wave 3: 02-03-PLAN.md — Include/exclude rules + structured diagnostics

Verification warnings (non-blocking):
- Plan 02-03 Task 2 is large (68 lines) - combines filtering, error handling, diagnostics, and tests
- Consider splitting into sub-tasks during execution for better granularity

Next action: Run `/gsd:execute-phase 2` to begin execution.

</remaining_work>

<decisions_made>

From Phase 2 context discussion (preserved in CONTEXT.md):
- Batch processing with configurable `--debounce-ms` flag
- Deterministic sort by path within batch for reproducibility
- Backpressure handling for massive event storms (stop, notify, resume)
- Soft delete via separate deleted files list (not tombstones)
- Time-based expiry for deleted file records
- Configurable error output format (JSON/plain)
- Errors persisted to DB for later query
- Error limit threshold to prevent runaway failures
- Gitignore-style patterns for ignore/include/exclude
- Hybrid: `.magellanignore` + CLI flags
- Last-wins precedence for conflicting patterns

From planning update (2026-01-19):
- Design principles integrated into all 3 plans as foundational notes
- SQLiteGraph API features documented (add_label, add_property, raw SQL access)
- Clear deferred items documented (Phase 3: JSON contract, Phase 4: span model, Phase 5: execution_id, Phase 8: validation hooks)

From research + verification (2026-01-19):
- Deletion primitives already exist (delete_file_facts, delete_references_in_file, delete_calls_in_file)
- ReconcileOutcome enum already exists - just needs public API wrapper
- notify 7.0 vs 8.x decision checkpoint added to Plan 02-02
- ignore crate dependency noted (must be added in Plan 02-03)
- Plans verified - passed with 3 non-blocking warnings about Task 2 scope in 02-03

</decisions_made>

<blockers>

UNCOMMITTED changes exist in src/ - should be reviewed before execution:
- src/graph/call_ops.rs
- src/graph/count.rs
- src/graph/mod.rs
- src/graph/ops.rs
- src/graph/query.rs
- src/graph/references.rs
- src/graph/schema.rs
- src/lib.rs

Current diagnostics indicate:
- src/mod.rs:304 - `reconcile_file_path` not found in ops
- src/graph/ops.rs:183 - `neighbors` method needs GraphBackend trait in scope
- src/graph/ops.rs:6 - unused import: Path

Recommendation: Stash or review these changes before executing Phase 2.

</blockers>

<context>

Phase 2 plans are complete, updated with research findings, and verified. Each plan has:
1. "Design Principles (Phase 2 Foundation)" section explaining how it advances Magellan's core principles
2. Documentation of deferred work to future phases
3. References to relevant SQLiteGraph API features
4. Integration of current codebase state (deletion primitives exist, ReconcileOutcome exists, etc.)

The plans are ready for autonomous execution. Phase 2 establishes the deterministic watch foundation that Phase 3 (JSON output), Phase 4 (span model), and Phase 5 (stable IDs) will build upon.

</context>

<next_action>

1. Handle uncommitted changes (stash or review) - currently 8 files with uncommitted changes
2. Run `/gsd:execute-phase 2` to begin Phase 2 execution

</next_action>
