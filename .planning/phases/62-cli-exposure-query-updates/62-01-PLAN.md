---
phase: 62-cli-exposure-query-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/refs_cmd.rs, src/find_cmd.rs, tests/backend_migration_tests.rs]
autonomous: true

must_haves:
  truths:
    - "refs command shows references from all files in codebase"
    - "find command returns multi-file results with correct locations"
    - "query command includes cross-file relationships in results"
    - "Cross-file reference tests pass (tests/backend_migration_tests.rs:648-987)"
  artifacts:
    - path: "src/refs_cmd.rs"
      provides: "CLI refs command with cross-file reference display"
      exports: ["run_refs", "output_json_mode"]
      covered_by: "Task 1"
    - path: "src/find_cmd.rs"
      provides: "CLI find command with multi-file symbol search"
      exports: ["run_find", "find_all_files", "output_json_mode"]
      covered_by: "Task 2"
    - path: "tests/backend_migration_tests.rs"
      provides: "Integration tests verifying cross-file CLI functionality"
      exports: ["test_cross_file_reference_indexing", "test_refs_command_multi_file", "test_find_command_multi_file"]
      covered_by: "Task 3"
  key_links:
    - from: "src/refs_cmd.rs"
      to: "graph call/reference queries"
      via: "calls_from_symbol/callers_of_symbol graph methods"
      pattern: "calls_from_symbol|callers_of_symbol"
    - from: "src/find_cmd.rs"
      to: "all_file_nodes and symbol queries"
      via: "graph.all_file_nodes and symbol_nodes_in_file_with_ids"
      pattern: "all_file_nodes|symbol_nodes_in_file_with_ids"
---

<objective>
Verify and document that CLI commands correctly expose cross-file resolution functionality.

Phase 61 built the infrastructure for cross-file reference and call indexing. Phase 62
ensures users can access this functionality through CLI commands with clear, structured output.

The infrastructure already exists - this plan verifies CLI commands work correctly and
cross-file tests pass. No new algorithmic work is needed, only verification and documentation.

Purpose: Expose Phase 61 cross-file functionality through CLI commands
Output: Verified CLI commands with passing cross-file tests
</objective>

<execution_context>
@/home/feanor/.claude/get-shit-done/workflows/execute-plan.md
@/home/feanor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/61-cross-file-resolution/61-01-SUMMARY.md
@.planning/phases/61-cross-file-resolution/61-02-SUMMARY.md
@.planning/phases/61-cross-file-resolution/61-03-SUMMARY.md

@src/refs_cmd.rs
@src/find_cmd.rs
@src/query_cmd.rs
@src/graph/query.rs
@tests/backend_migration_tests.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify refs command cross-file functionality</name>
  <files>src/refs_cmd.rs</files>
  <action>
  Verify refs command correctly shows cross-file calls:

  1. Review refs_cmd.rs implementation:
     - calls_from_symbol queries graph for outgoing calls (all files)
     - callers_of_symbol queries graph for incoming calls (all files)
     - Output includes file_path for each call (CallFact.file_path)

  2. Verify output format clearly shows cross-file relationships:
     - Human mode: "From: caller (Function) at path/to/caller.rs:42"
     - Human mode: "To: callee at path/to/caller.rs:42" (shows call location)
     - JSON mode: ReferenceMatch includes span with file_path

  3. Confirm no changes needed - the infrastructure from Phase 61 already works:
     - calls_from_symbol returns CallFact with file_path for each call
     - callers_of_symbol returns CallFact with file_path for each caller
     - Output iterates all calls regardless of which file they're from

  4. Add clarifying comments if output format could be more clear

  The refs command already uses graph queries that return cross-file data.
  This task verifies correctness and adds clarity if needed.
  </action>
  <verify>cargo test --lib test_refs_command_multi_file</verify>
  <verify>cargo test --lib test_refs_command_cross_file_direction_flags</verify>
  <done>refs command shows calls from/to all files with clear file_path in output</done>
</task>

<task type="auto">
  <name>Task 2: Verify find command multi-file functionality</name>
  <files>src/find_cmd.rs</files>
  <action>
  Verify find command correctly returns symbols from multiple files:

  1. Review find_all_files function (lines 64-102):
     - Queries all_file_nodes() to get every indexed file
     - Searches each file for matching symbol name
     - Returns FoundSymbol with correct file_path for each match

  2. Verify output shows file_path for multi-file results:
     - Single result: Shows file path clearly
     - Multiple results: Shows count, guides user to --ambiguous flag
     - JSON mode: Each SymbolMatch includes span with file_path

  3. Confirm the implementation already handles multi-file correctly:
     - find_all_files iterates all files in database
     - Each FoundSymbol has correct file from symbol.file_path
     - Results are sorted deterministically by file_path

  4. Add clarifying comments if multi-file behavior needs documentation

  The find command already searches across all files.
  This task verifies correctness and documentation.
  </action>
  <verify>cargo test --lib test_find_command_multi_file</verify>
  <done>find command returns symbols from all files with correct locations</done>
</task>

<task type="auto">
  <name>Task 3: Run cross-file integration tests and verify all pass</name>
  <files>tests/backend_migration_tests.rs</files>
  <action>
  Run all cross-file integration tests to verify CLI exposure works:

  1. Run test_cross_file_reference_indexing (line 648):
     - Creates three files with cross-file references
     - Verifies references_to_symbol returns refs from multiple files
     - Confirms file_path is correct for each reference

  2. Run test_refs_command_multi_file (line 771):
     - Creates three files with cross-file calls
     - Verifies refs command shows calls from multiple files
     - Confirms output includes correct file_path

  3. Run test_find_command_multi_file (line 888):
     - Creates two files with same-named symbols
     - Verifies find returns results from both files
     - Confirms each result has correct file_path

  4. If any test fails, debug and fix:
     - Check if graph queries return cross-file data
     - Verify file_path is populated correctly
     - Confirm output format includes file information

  All tests should pass based on Phase 61 infrastructure.
  This task confirms the end-to-end flow works.
  </action>
  <verify>cargo test test_cross_file_reference_indexing</verify>
  <verify>cargo test test_refs_command_multi_file</verify>
  <verify>cargo test test_find_command_multi_file</verify>
  <done>All cross-file integration tests pass, confirming CLI commands expose multi-file relationships</done>
</task>

</tasks>

<verification>
Overall phase checks:
- refs command shows references from all files in codebase
- find command returns multi-file results with correct locations
- query command includes cross-file relationships (via graph queries)
- Cross-file reference tests pass (tests/backend_migration_tests.rs:648-987)
</verification>

<success_criteria>
1. cargo test test_cross_file_reference_indexing passes
2. cargo test test_refs_command_multi_file passes
3. cargo test test_find_command_multi_file passes
4. Manual verification: refs --direction in/out shows calls from multiple files
5. Manual verification: find returns symbols from multiple files with correct paths
</success_criteria>

<output>
After completion, create `.planning/phases/62-cli-exposure-query-updates/62-01-SUMMARY.md`
</output>
