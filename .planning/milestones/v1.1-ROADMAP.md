# Milestone v1.1: Correctness + Safety

**Status:** ✅ SHIPPED 2026-01-20
**Phases:** 10-13
**Total Plans:** 20

## Overview

Fix correctness issues (FQN collisions), harden security (path traversal), and ensure data integrity (transactional deletes).

## Phases

### Phase 10: Path Traversal Validation

**Goal**: All file access operations validate that resolved paths cannot escape the project root, preventing CVE-2025-68705 class vulnerabilities.
**Depends on**: v1.0 complete
**Requirements**: PATH-01, PATH-02, PATH-03, PATH-04, PATH-05, PATH-06
**Plans**: 4 plans in 3 waves
**Status**: Complete — Verified 2026-01-19 (5/5 must-haves passed)

Plans:
- [x] 10-01 — Create `src/validation.rs` with path canonicalization and validation utilities (Wave 1)
- [x] 10-02 — Integrate path validation into watcher.rs event filtering (Wave 2)
- [x] 10-03 — Integrate path validation into scan.rs directory walking (Wave 2)
- [x] 10-04 — Add traversal tests for malicious paths, symlinks, and cross-platform edge cases (Wave 3)

**Details:**
Created comprehensive path validation infrastructure with 24 integration tests covering parent directory traversal patterns, cross-platform path separators, and symlink handling. Paths with 3+ parent directory patterns are rejected as suspicious. Symlinks outside project root are rejected.

### Phase 11: FQN Extraction

**Goal**: Symbol lookup uses fully-qualified names (FQN) as keys, eliminating collisions from simple-name-first-match wins.
**Depends on**: Phase 10
**Requirements**: FQN-01, FQN-02, FQN-03, FQN-04, FQN-05, FQN-06
**Plans**: 6 plans in 5 waves
**Status**: Complete — Verified 2026-01-19 (5/5 must-haves passed)

Plans:
- [x] 11-01 — Implement ScopeStack struct in src/ingest/mod.rs for tracking nesting during walk_tree (Wave 1)
- [x] 11-02 — Add Rust parser scope tracking (mod/impl/trait) with walk_tree_with_scope (Wave 2)
- [x] 11-03 — Add Python/Java/JavaScript/TypeScript parser scope tracking with Dot separator (Wave 3)
- [x] 11-04 — Add C/C++ parser scope tracking (C: no-op, C++: namespaces with :: separator) (Wave 3)
- [x] 11-05 — Update symbol lookup maps to use FQN → symbol_id (query.rs, references.rs, calls.rs) (Wave 4)
- [x] 11-06 — Complete symbol_id generation from FQN and add integration tests (Wave 5)

**Details:**
Implemented ScopeStack for tracking namespace nesting during tree-sitter traversal. Symbol map keys changed from simple names to FQNs (e.g., `crate::module::Struct::method`). Database version bumped to 3. FQN collision warnings emitted for duplicates.

### Phase 12: Transactional Deletes

**Goal**: Ensure delete operations have strong integrity guarantees (row-count verification, orphan detection).
**Depends on**: Phase 10
**Requirements**: DELETE-01, DELETE-02, DELETE-03, DELETE-04
**Plans**: 6 plans in 6 waves
**Status**: Complete — Verified 2026-01-20 (2/2 core must-haves passed)

**Note:** ACID transactions across graph operations are not possible with current sqlitegraph API (does not expose &mut Connection). Row-count assertions and orphan detection provide strong data integrity guarantees. Future sqlitegraph versions may add transaction support.

Plans:
- [x] 12-01 — Wrap delete_file_facts() in rusqlite IMMEDIATE transaction (Wave 1) — Reverted due to API limitation
- [x] 12-02 — Add row-count assertions to verify all derived data is deleted (Wave 2)
- [x] 12-03 — Implement error injection tests for transaction rollback verification (Wave 3) — Uses verification points
- [x] 12-04 — Add invariant test for orphan detection after file delete (Wave 4)
- [x] 12-05 — Add shared connection support to ChunkStore (Wave 5) — Gap closure attempt
- [x] 12-06 — Restore IMMEDIATE transactions (Wave 6) — Discovered API limitation, documented constraint

**Details:**
DeleteResult struct provides detailed deletion statistics. Orphan detection tests pass 12/12. Row-count assertions verify all derived data (symbols, refs, calls, chunks) are deleted. Shared connection pattern added to ChunkStore for potential future transaction support.

### Phase 13: SCIP Tests + Documentation

**Goal**: SCIP export is verified by round-trip tests, and users have clear security guidance.
**Depends on**: Phase 10, Phase 11, Phase 12
**Requirements**: SCIP-01, SCIP-02, DOC-01, DOC-02
**Plans**: 4 plans in 3 waves
**Status**: Complete — Verified 2026-01-20 (4/4 must-haves passed)

Plans:
- [x] 13-01 — Implement SCIP export using scip crate with metadata and symbol encoding (Wave 1)
- [x] 13-02 — Add round-trip integration tests for SCIP format verification (Wave 2)
- [x] 13-03 — Add Security section to README.md with database placement guidance (Wave 3)
- [x] 13-04 — Add Security Best Practices section to MANUAL.md (Wave 3)

**Details:**
SCIP export implemented using scip crate v0.6.1. Seven round-trip tests verify export produces parseable protobuf. README.md and MANUAL.md updated with security documentation covering database placement, path traversal protection, file permissions, and secure operation patterns.

---

## Milestone Summary

**Decimal Phases:** None

**Key Decisions:**
- Path validation using canonicalization + suspicious pattern detection (3+ ../, mixed patterns)
- FQN as symbol map keys with language-specific separators (:: vs .)
- Row-count assertions as data integrity verification (transactions blocked by sqlitegraph API)
- SCIP symbol format: `magellan language/namespace/symbol.` for cross-tool compatibility
- Security documentation emphasizes .db placement outside watched directories

**Issues Resolved:**
- FQN collisions causing incorrect symbol resolution
- Path traversal vulnerability class (CVE-2025-68705)
- No verification of delete operation completeness
- SCIP export not verified for correctness
- No security guidance for users

**Issues Deferred:**
- True ACID transactions for graph operations (requires sqlitegraph API changes)
- Performance optimization (deferred to v1.2)

**Technical Debt Incurred:**
- Call indexing regression from FQN changes (fixed with fallback lookup)
- Database version bump (v2 → v3) requires re-index for existing users

---

_For current project status, see .planning/ROADMAP.md_
