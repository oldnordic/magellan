# v2.1 Backend Parity Completion — Archived Requirements

**Archived:** 2026-02-08
**Milestone:** v2.1 Backend Parity Completion
**Status:** SHIPPED

---

## Requirements Coverage

| Requirement | Phase | Status |
|-------------|-------|--------|
| QUERY-01: magellan chunks command | 58 | ✅ Complete |
| QUERY-02: magellan get command | 58 | ✅ Complete |
| QUERY-03: magellan get-file command | 58 | ✅ Complete |
| QUERY-04: magellan ast command | 59 | ✅ Complete |
| QUERY-05: magellan find-ast command | 59 | ✅ Complete |
| CHUNK-01: get_chunks_for_file() KV support | 56 | ✅ Complete |
| CHUNK-03: get_chunk_by_span() KV support | 57 | ✅ Complete |
| VERIFY-01: Cross-backend test suite | 59 | ✅ Complete |

**Coverage:** 8/8 requirements (100%)

---

## Requirements Detail

### QUERY-01: magellan chunks command

**Description:** User can run `magellan chunks` on Native-V2 backend and see all code chunks with filtering options.

**Implementation:**
- KV prefix scan on `chunk:*` keys retrieves all chunks
- Filters: --file, --kind, --limit
- Tests: 5 CLI integration tests in src/get_cmd.rs

**Evidence:**
- test_magellan_chunks_command
- test_magellan_chunks_with_file_filter
- test_magellan_chunks_with_kind_filter
- test_magellan_chunks_with_limit
- test_magellan_chunks_combined_filters

**Files:**
- src/get_cmd.rs:99-119 (Native-V2 branch)
- src/generation/mod.rs:755 (kv_prefix_scan)

---

### QUERY-02: magellan get command

**Description:** User can run `magellan get --file <path> --symbol <name>` on Native-V2 backend to retrieve chunks for a specific symbol.

**Implementation:**
- Uses ChunkStore::get_chunks_for_symbol() with KV support
- KV prefix scan on `chunk:{escaped_path}:` then filters by symbol_name

**Evidence:**
- test_magellan_get_command
- test_magellan_get_cross_backend_parity
- test_magellan_get_empty_result
- test_magellan_get_filters_by_symbol_name
- test_magellan_get_with_colon_path

**Files:**
- src/get_cmd.rs:162 (run_get)
- src/graph/mod.rs:680-686 (get_code_chunks_for_symbol)
- src/generation/mod.rs:606-625 (get_chunks_for_symbol)

---

### QUERY-03: magellan get-file command

**Description:** User can run `magellan get-file <path>` on Native-V2 backend to retrieve all chunks for a file.

**Implementation:**
- Uses ChunkStore::get_chunks_for_file() with KV prefix scan
- Pattern: `chunk:{escaped_path}:*`

**Evidence:**
- test_get_chunks_for_file_cross_backend
- test_get_chunks_for_file_with_colon_path
- test_get_chunks_for_file_empty_result
- test_get_chunks_for_file_byte_order

**Files:**
- src/get_cmd.rs:306 (run_get_file)
- src/graph/mod.rs:668-670 (get_code_chunks)
- src/generation/mod.rs:523-588 (get_chunks_for_file)

---

### QUERY-04: magellan ast command

**Description:** User can run `magellan ast --file <path>` on Native-V2 backend to see AST nodes for a file.

**Implementation:**
- Uses get_ast_nodes_by_file() with KV lookup via ast_nodes_key(file_id)
- **Limitation:** --position flag not supported (SQLite-only)

**Evidence:**
- test_magellan_ast_command_structure
- test_print_node_tree_basic
- test_get_ast_nodes_by_file_native_v2

**Files:**
- src/ast_cmd.rs:129 (run_ast_command)
- src/graph/ast_ops.rs:50-80 (get_ast_nodes_by_file)
- src/graph/files.rs:115-120, 146-151 (file:path KV storage)

---

### QUERY-05: magellan find-ast command

**Description:** User can run `magellan find-ast --kind <kind>` on Native-V2 backend to get filtered AST nodes.

**Implementation:**
- Uses get_ast_nodes_by_kind() with KV prefix scan on `ast:file:` keys

**Evidence:**
- test_magellan_find_ast_command_structure
- test_magellan_find_ast_empty_result
- test_get_ast_nodes_by_kind_native_v2

**Files:**
- src/ast_cmd.rs:172 (run_find_ast_command)
- src/graph/ast_ops.rs:197-224 (get_ast_nodes_by_kind)

---

### CHUNK-01: get_chunks_for_file() KV support

**Description:** ChunkStore method retrieves all chunks for a file using KV prefix scan on Native-V2 backend.

**Implementation:**
- KV prefix scan pattern: `chunk:{escaped_path}:*`
- Colon escaping with `::`
- Sort by byte_start for consistent ordering

**Evidence:**
- test_get_chunks_for_file_cross_backend
- test_get_chunks_for_file_with_colon_path
- test_get_chunks_for_file_empty_result
- test_get_chunks_for_file_byte_order

**Files:**
- src/generation/mod.rs:523-588 (get_chunks_for_file)

---

### CHUNK-03: get_chunk_by_span() KV support

**Description:** ChunkStore method retrieves chunk by exact span using KV key lookup on Native-V2 backend.

**Implementation:**
- Uses chunk_key() for O(1) exact span lookup
- Key format: `chunk:{escaped_file_path}:{start}:{end}`

**Evidence:**
- test_get_chunk_by_span_cross_backend
- test_get_chunk_by_span_with_colon_path
- test_get_chunk_by_span_empty_result
- test_get_chunk_by_span_exact_match_required
- test_get_chunk_by_span_multiple_chunks_same_file
- test_get_chunk_by_span_zero_length

**Files:**
- src/generation/mod.rs:467-485 (get_chunk_by_span)

---

### VERIFY-01: Cross-backend test suite

**Description:** Comprehensive test suite verifies all query commands work identically on SQLite and Native-V2 backends.

**Implementation:**
- 14 backend integration tests in tests/backend_integration_tests.rs
- Unified E2E test: test_all_query_commands_native_v2()

**Test Results:**
```
running 14 tests
test test_ast_queries_empty_results ... ok
test test_get_chunk_by_span_exact_match_required ... ok
test test_get_chunk_by_span_empty_result ... ok
test test_get_chunk_by_span_cross_backend ... ok
test test_get_chunk_by_span_multiple_chunks_same_file ... ok
test test_get_chunk_by_span_zero_length ... ok
test test_get_chunks_for_file_empty_result ... ok
test test_get_chunk_by_span_with_colon_path ... ok
test test_get_chunks_for_file_byte_order ... ok
test test_get_chunks_for_file_with_colon_path ... ok
test test_get_chunks_for_file_cross_backend ... ok
test test_get_ast_nodes_by_kind_native_v2 ... ok
test test_get_ast_nodes_by_file_native_v2 ... ok
test test_all_query_commands_native_v2 ... ok

test result: ok. 14 passed; 0 failed
```

**Files:**
- tests/backend_integration_tests.rs (entire file)
- tests/cli_integration_tests.rs (5 get command tests)
- src/get_cmd.rs tests module (5 chunks command tests)
- src/ast_cmd.rs tests module (4 ast command tests)

---

## Known Limitations

| Feature | Backend Support | Notes |
|---------|----------------|-------|
| `magellan ast --position` | ❌ SQLite-only | Documented in NATIVE-V2.md |
| `magellan chunk-by-symbol` | ❌ SQLite-only | Out of scope for v2.1 |
| Graph algorithms (cycles, dead-code, reachable) | ❌ SQLite-only | Documented in NATIVE-V2.md |

---

## Gaps Identified (Out of Scope)

| Gap | Severity | Impact |
|-----|----------|--------|
| run_chunk_by_symbol() uses direct SQL instead of KV backend | Medium | magellan chunk-by-symbol command doesn't work on Native-V2 |

---

*Archived from REQUIREMENTS.md - 2026-02-08*
