name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Standard tests on stable Rust
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run tests
        run: cargo test --all-targets

  # Performance regression tests on release build
  #
  # Performance tests verify that indexing speed hasn't degraded >5% from baseline.
  # - On PR: Compare PR performance against main branch baseline
  # - On main: Update baseline after merge (regression tests create new baseline)
  # - 5% variance allowed for measurement noise (OS scheduling, thermal throttling)
  # - PR authors must justify regressions >5% in code review
  #
  # To update baseline: Push to main branch after performance improvements
  perf-regression:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Fetch full history for baseline comparison on PRs
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      # On PR: Check out main branch to get baseline
      - name: Fetch main branch baseline
        if: github.event_name == 'pull_request'
        run: |
          git checkout origin/main
          cp .planning/phases/33-verification/PERFORMANCE_BASELINE.json /tmp/baseline.json || echo "No baseline yet"
          git checkout -

      # On PR: Restore baseline before running tests
      - name: Restore baseline on PR
        if: github.event_name == 'pull_request'
        run: |
          if [ -f /tmp/baseline.json ]; then
            cp /tmp/baseline.json .planning/phases/33-verification/PERFORMANCE_BASELINE.json
            echo "Baseline restored from main branch"
          else
            echo "No baseline found on main branch - will create new baseline"
          fi

      - name: Run performance tests
        run: cargo test --test performance_regression --release

      - name: Upload baseline
        uses: actions/upload-artifact@v4
        with:
          name: performance-baseline
          path: .planning/phases/33-verification/PERFORMANCE_BASELINE.json
          if-no-files-found: warn

  # ThreadSanitizer tests on nightly Rust
  #
  # NOTE: TSAN integration is currently blocked by Rust toolchain limitations.
  # The -Zsanitizer=thread flag requires all dependencies (including std)
  # to be compiled with the same sanitizer flag, which causes ABI mismatches.
  #
  # This job is kept for when TSAN support stabilizes in Rust.
  # See: TEST-01-TSAN-RESULTS.md for details on current limitations.
  #
  # To enable when TSAN is available:
  # 1. Remove the 'if: false' condition
  # 2. Update Rust version to one with working TSAN support
  # 3. Verify -Zsanitizer=thread works without ABI errors
  tsan:
    runs-on: ubuntu-latest
    if: false  # Disabled until TSAN support stabilizes in Rust
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
      - name: Run TSAN tests
        run: RUSTFLAGS="-Zsanitizer=thread" cargo test --test tsan_thread_safety_tests
